<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexTalk - Feed</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb, rgba(255, 255, 255, 0.1));
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover, rgba(255, 255, 255, 0.2));
        }

        /* Story Rings */
        .story-ring-new {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }

        .story-ring-seen {
            background: #3f3f46;
        }

        /* Animations */
        @keyframes progress {
            from {
                width: 0%;
            }

            to {
                width: 100%;
            }
        }

        .animate-progress {
            animation: progress 5s linear forwards;
        }

        /* Theme Variables Defaults */
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --accent: #7A4DFF;
            --border: rgba(255, 255, 255, 0.05);
            --msg-me: #7A4DFF;
            --msg-them: #27272a;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
    </style>
</head>

<body class="h-screen overflow-hidden selection:bg-[#7A4DFF] selection:text-white" id="app-body">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            MessageSquare, Users, Settings, Heart, Send, Plus,
            Image as ImageIcon, Search, Bell, LogOut,
            MoreVertical, Phone, Video, X, Zap, Eye, EyeOff,
            Hash, Mail, AlertTriangle, CheckCircle, RefreshCw,
            Camera, ChevronLeft, ChevronRight, Shield,
            User, Lock, Trash2, Ban, Globe, Mic, Volume2, UserPlus,
            Paperclip, MessageCircle, Activity, Skull, Ghost, Megaphone
        } from 'lucide-react';

        import { initializeApp } from 'firebase/app';
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            onAuthStateChanged, signOut, sendEmailVerification, sendPasswordResetEmail, updatePassword, updateEmail
        } from 'firebase/auth';
        import {
            getFirestore, collection, doc, setDoc, addDoc, onSnapshot,
            query, orderBy, serverTimestamp, updateDoc, deleteDoc, getDoc, where, arrayUnion, arrayRemove
        } from 'firebase/firestore';

        window.process = { env: { NODE_ENV: 'production' } };

        const firebaseConfig = {
            apiKey: "AIzaSyClqVa0abAGdbWre1SgNQ_LPE3OhFgwqC4",
            authDomain: "nextalk-4cb86.firebaseapp.com",
            projectId: "nextalk-4cb86",
            storageBucket: "nextalk-4cb86.firebasestorage.app",
            messagingSenderId: "894596255124",
            appId: "1:894596255124:web:6fdd8b80b8e96fc9aad381",
            measurementId: "G-M8EDS7KCE2"
        };

        const _appId = 'nextalk-production-v11';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const generateFriendCode = () => {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const prefix = Array(3).fill(0).map(() => letters[Math.floor(Math.random() * letters.length)]).join('');
            const suffix = Math.floor(100000 + Math.random() * 900000).toString();
            return `${prefix}-${suffix}`;
        };

        const getAvatar = (uid) => `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}&backgroundColor=b6e3f4`;

        const handleRealFileUpload = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        const getRelativeTime = (timestamp) => {
            if (!timestamp) return 'Nyní';
            const now = new Date();
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diff = Math.floor((now - date) / 1000); // seconds

            if (diff < 60) return 'před chvílí';
            if (diff < 3600) return `před ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `před ${Math.floor(diff / 3600)} hod`;
            if (diff < 604800) return `před ${Math.floor(diff / 86400)} dny`;
            return date.toLocaleDateString();
        };

        const ThemeInjector = ({ theme, customColors }) => {
            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'light') {
                    root.style.setProperty('--bg-primary', '#f4f4f5');
                    root.style.setProperty('--bg-secondary', '#ffffff');
                    root.style.setProperty('--bg-tertiary', '#e4e4e7');
                    root.style.setProperty('--text-primary', '#18181b');
                    root.style.setProperty('--text-secondary', '#71717a');
                    root.style.setProperty('--border', 'rgba(0,0,0,0.1)');
                    root.style.setProperty('--scrollbar-thumb', 'rgba(0,0,0,0.2)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#e4e4e7');
                } else if (theme === 'custom' && customColors) {
                    root.style.setProperty('--bg-primary', customColors.bgPrimary);
                    root.style.setProperty('--bg-secondary', customColors.bgSecondary);
                    root.style.setProperty('--bg-tertiary', customColors.bgSecondary + '80');
                    root.style.setProperty('--text-primary', customColors.text);
                    root.style.setProperty('--text-secondary', customColors.text + '99');
                    root.style.setProperty('--accent', customColors.accent);
                    root.style.setProperty('--border', customColors.text + '20');
                    root.style.setProperty('--msg-me', customColors.accent);
                    root.style.setProperty('--msg-them', customColors.bgSecondary + '90');
                } else {
                    root.style.setProperty('--bg-primary', '#0f0f13');
                    root.style.setProperty('--bg-secondary', '#18181b');
                    root.style.setProperty('--bg-tertiary', '#27272a');
                    root.style.setProperty('--text-primary', '#ffffff');
                    root.style.setProperty('--text-secondary', 'rgba(255,255,255,0.6)');
                    root.style.setProperty('--border', 'rgba(255,255,255,0.05)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#27272a');
                }
            }, [theme, customColors]);
            return null;
        };

        const GlassCard = ({ children, className = "", onClick, onContextMenu }) => (
            <div onClick={onClick} onContextMenu={onContextMenu} className={`backdrop-blur-xl bg-[var(--bg-secondary)] border border-[var(--border)] shadow-xl ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, className = "", variant = "primary" }) => {
            const styles = {
                primary: "bg-[var(--accent)] text-white hover:brightness-110",
                secondary: "bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-opacity-80",
                danger: "bg-red-500/20 text-red-500 hover:bg-red-500/30"
            };
            return (
                <button onClick={onClick} className={`px-4 py-2 rounded-xl font-bold transition-all active:scale-95 ${styles[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        // FEED
        const Feed = ({ user, allUsers }) => {
            const [posts, setPosts] = useState([]);
            const [stories, setStories] = useState([]);
            const [newPostText, setNewPostText] = useState("");
            const [viewingStory, setViewingStory] = useState(null);
            const [commentInput, setCommentInput] = useState({});
            const [showComments, setShowComments] = useState({});
            const [storyReply, setStoryReply] = useState("");

            useEffect(() => {
                const q1 = query(collection(db, 'artifacts', _appId, 'public', 'data', 'posts'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q1, snap => setPosts(snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.deleted)));

                const q2 = query(collection(db, 'artifacts', _appId, 'public', 'data', 'stories'), orderBy('createdAt', 'desc'));
                const unsubStories = onSnapshot(q2, snap => {
                    const now = Date.now();
                    const validStories = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(s => {
                        if (s.deleted) return false;
                        if (!s.createdAt) return false;
                        const time = s.createdAt.toMillis();
                        return (now - time) < (24 * 60 * 60 * 1000);
                    });

                    const grouped = validStories.reduce((acc, s) => {
                        if (!acc[s.authorId]) acc[s.authorId] = [];
                        acc[s.authorId].push(s);
                        return acc;
                    }, {});
                    setStories(grouped);
                });

                return () => { unsub(); unsubStories(); };
            }, []);

            const handleUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const url = await handleRealFileUpload(file);

                if (type === 'story') {
                    await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'stories'), {
                        authorId: user.uid, imageUrl: url, createdAt: serverTimestamp(), viewers: []
                    });
                } else {
                    await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'posts'), {
                        authorId: user.uid, authorName: user.displayName, authorAvatar: user.avatarUrl,
                        content: newPostText, imageUrl: url, likes: [], comments: [], createdAt: serverTimestamp()
                    });
                    setNewPostText("");
                }
            };

            const handlePost = async () => {
                if (!newPostText) return;
                await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'posts'), {
                    authorId: user.uid, authorName: user.displayName, authorAvatar: user.avatarUrl,
                    content: newPostText, imageUrl: null, likes: [], comments: [], createdAt: serverTimestamp()
                });
                setNewPostText("");
            };

            const handleDeletePost = async (pid) => { await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'posts', pid), { deleted: true }); };

            const toggleLike = async (post) => {
                const postRef = doc(db, 'artifacts', _appId, 'public', 'data', 'posts', post.id);
                let newLikes = post.likes || [];
                if (newLikes.includes(user.uid)) newLikes = newLikes.filter(id => id !== user.uid);
                else newLikes.push(user.uid);
                await updateDoc(postRef, { likes: newLikes });
            };

            const sendComment = async (postId) => {
                if (!commentInput[postId]) return;
                const postRef = doc(db, 'artifacts', _appId, 'public', 'data', 'posts', postId);
                const newComment = {
                    id: crypto.randomUUID(), // Native UUID
                    uid: user.uid,
                    text: commentInput[postId],
                    createdAt: Date.now()
                };
                const post = posts.find(p => p.id === postId);
                const currentComments = post.comments || [];
                await updateDoc(postRef, { comments: [...currentComments, newComment] });
                setCommentInput({ ...commentInput, [postId]: "" });
            };

            const deleteComment = async (postId, commentId) => {
                const postRef = doc(db, 'artifacts', _appId, 'public', 'data', 'posts', postId);
                const post = posts.find(p => p.id === postId);
                const updatedComments = (post.comments || []).filter(c => c.id !== commentId);
                await updateDoc(postRef, { comments: updatedComments });
            };

            const openStory = async (uid, list) => {
                const story = list[0];
                setViewingStory({ uid, index: 0, list });
                if (story.authorId !== user.uid && !story.viewers?.includes(user.uid)) {
                    const storyRef = doc(db, 'artifacts', _appId, 'public', 'data', 'stories', story.id);
                    await updateDoc(storyRef, { viewers: arrayUnion(user.uid) });
                }
            };

            const deleteStory = async () => {
                const currentStory = viewingStory.list[viewingStory.index];
                if (currentStory.authorId !== user.uid) return;
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'stories', currentStory.id), { deleted: true });
                setViewingStory(null);
            };

            const replyToStory = async () => {
                if (!storyReply.trim()) return;
                const currentStory = viewingStory.list[viewingStory.index];
                await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'messages'), {
                    from: user.uid,
                    to: currentStory.authorId,
                    text: `Reagoval na story: ${storyReply}`,
                    createdAt: serverTimestamp()
                });
                setStoryReply("");
                alert("Odesláno!");
            };

            const toggleViewers = (story) => {
                if (story.authorId !== user.uid) return;
                const names = story.viewers?.map(vUid => allUsers[vUid]?.displayName).filter(Boolean).join(", ") || "Nikdo";
                alert(`Viděli to: ${names}`);
            };

            return (
                <div className="h-full overflow-y-auto p-8 bg-[var(--bg-primary)]">
                    <div className="max-w-2xl mx-auto space-y-8">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-[var(--text-primary)]">Feed</h2>
                        </div>

                        <div className="flex gap-4 overflow-x-auto pb-4 scrollbar-hide">
                            <div className="flex flex-col items-center gap-2 cursor-pointer group relative flex-shrink-0">
                                <div className="w-[70px] h-[70px] rounded-full border-2 border-dashed border-[var(--text-secondary)] flex items-center justify-center bg-[var(--bg-secondary)] overflow-hidden relative group-hover:border-[var(--accent)] transition">
                                    <Plus className="text-[var(--text-secondary)]" />
                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleUpload(e, 'story')} />
                                </div>
                                <span className="text-xs text-[var(--text-secondary)]">Přidat</span>
                            </div>
                            {Object.entries(stories).map(([uid, list]) => {
                                const hasUnseen = list.some(s => !s.viewers?.includes(user.uid));
                                return (
                                    <div key={uid} className="flex flex-col items-center gap-2 cursor-pointer flex-shrink-0" onClick={() => openStory(uid, list)}>
                                        <div className={`p-[2px] rounded-full ${hasUnseen ? 'story-ring-new' : 'story-ring-seen'}`}>
                                            <div className="p-[2px] bg-[var(--bg-primary)] rounded-full">
                                                <img src={allUsers[uid]?.avatarUrl} className="w-[62px] h-[62px] rounded-full object-cover" />
                                            </div>
                                        </div>
                                        <span className="text-xs truncate w-16 text-center text-[var(--text-primary)]">{allUsers[uid]?.displayName}</span>
                                    </div>
                                );
                            })}
                        </div>

                        <GlassCard className="p-6 rounded-2xl">
                            <div className="flex gap-4">
                                <img src={user.avatarUrl} className="w-12 h-12 rounded-full" />
                                <div className="flex-1 space-y-3">
                                    <textarea value={newPostText} onChange={e => setNewPostText(e.target.value)} placeholder="Co se děje?" className="w-full bg-transparent text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none resize-none" />
                                    <div className="flex justify-between pt-2 border-t border-[var(--border)]">
                                        <div className="relative overflow-hidden group">
                                            <button className="flex items-center gap-2 text-[var(--accent)] text-sm hover:bg-[var(--bg-tertiary)] px-3 py-1 rounded-lg transition"><ImageIcon size={16} /> Fotka</button>
                                            <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleUpload(e, 'post')} />
                                        </div>
                                        <Button onClick={handlePost} className="py-1 px-4 text-sm">Post</Button>
                                    </div>
                                </div>
                            </div>
                        </GlassCard>

                        <div className="space-y-6 pb-20">
                            {posts.map(p => (
                                <GlassCard key={p.id} className={`p-0 rounded-2xl overflow-hidden ${p.isAnnouncement ? 'border-2 border-[var(--accent)] shadow-[0_0_20px_rgba(122,77,255,0.2)]' : ''}`}>
                                    {p.isAnnouncement && (
                                        <div className="bg-[var(--accent)] text-white text-xs font-bold px-4 py-1 flex items-center gap-2">
                                            <Megaphone size={14} /> OZNÁMENÍ
                                        </div>
                                    )}
                                    <div className="p-5">
                                        <div className="flex justify-between mb-4">
                                            <div className="flex gap-3">
                                                <img src={p.authorAvatar} className="w-10 h-10 rounded-full" />
                                                <div>
                                                    <div className="font-bold text-[var(--text-primary)] flex items-center gap-2">
                                                        {p.authorName}
                                                        {p.isAnnouncement && <Shield size={14} className="text-[var(--accent)]" />}
                                                    </div>
                                                    <div className="text-xs text-[var(--text-secondary)]">{getRelativeTime(p.createdAt)}</div>
                                                </div>
                                            </div>
                                            {p.authorId === user.uid && <button onClick={(e) => { e.stopPropagation(); handleDeletePost(p.id); }} className="text-[var(--text-secondary)] hover:text-red-400"><Trash2 size={18} /></button>}
                                        </div>
                                        <p className="mb-4 text-[var(--text-primary)] opacity-90 whitespace-pre-wrap">{p.content}</p>
                                        {p.imageUrl && <img src={p.imageUrl} className="w-full rounded-xl mb-4 max-h-[500px] object-cover" />}
                                        <div className="flex items-center gap-1 text-xs text-[var(--text-secondary)]">
                                            <Heart size={12} fill={p.likes?.includes(user.uid) ? "currentColor" : "none"} className={p.likes?.includes(user.uid) ? "text-red-500" : ""} />
                                            {p.likes?.length || 0}
                                        </div>
                                    </div>

                                    <div className="bg-black/20 p-3 px-6 flex gap-6 border-t border-[var(--border)]">
                                        <button onClick={() => toggleLike(p)} className={`flex items-center gap-2 text-sm transition ${p.likes?.includes(user.uid) ? 'text-red-500' : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)]'}`}>
                                            <Heart size={18} fill={p.likes?.includes(user.uid) ? "currentColor" : "none"} /> Like
                                        </button>
                                        <button onClick={() => setShowComments({ ...showComments, [p.id]: !showComments[p.id] })} className="flex items-center gap-2 text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                                            <MessageCircle size={18} /> Komentáře ({p.comments?.length || 0})
                                        </button>
                                    </div>

                                    {showComments[p.id] && (
                                        <div className="p-4 bg-[var(--bg-tertiary)] border-t border-[var(--border)]">
                                            <div className="space-y-3 mb-4 max-h-40 overflow-y-auto custom-scrollbar">
                                                {p.comments?.map((c, idx) => (
                                                    <div key={idx} className="flex gap-2 justify-between group">
                                                        <div className="flex gap-2">
                                                            <span className="font-bold text-xs text-[var(--accent)]">{allUsers[c.uid]?.displayName}:</span>
                                                            <span className="text-xs text-[var(--text-primary)]">{c.text}</span>
                                                        </div>
                                                        {(c.uid === user.uid || p.authorId === user.uid) && (
                                                            <button onClick={() => deleteComment(p.id, c.id)} className="text-[var(--text-secondary)] hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><Trash2 size={12} /></button>
                                                        )}
                                                    </div>
                                                ))}
                                                {(!p.comments || p.comments.length === 0) && <div className="text-xs text-[var(--text-secondary)]">Žádné komentáře.</div>}
                                            </div>
                                            <div className="flex gap-2">
                                                <input
                                                    className="flex-1 bg-[var(--bg-secondary)] rounded-lg px-3 py-1 text-sm outline-none text-[var(--text-primary)]"
                                                    placeholder="Napiš komentář..."
                                                    value={commentInput[p.id] || ""}
                                                    onChange={e => setCommentInput({ ...commentInput, [p.id]: e.target.value })}
                                                    onKeyDown={e => e.key === 'Enter' && sendComment(p.id)}
                                                />
                                                <button onClick={() => sendComment(p.id)} className="text-[var(--accent)]"><Send size={16} /></button>
                                            </div>
                                        </div>
                                    )}
                                </GlassCard>
                            ))}
                        </div>
                    </div>

                    {viewingStory && (
                        <div className="fixed inset-0 z-50 bg-black flex items-center justify-center" onClick={() => setViewingStory(null)}>
                            <div className="w-full max-w-md h-full md:h-[80vh] bg-[#1a1a1a] relative md:rounded-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="absolute top-0 left-0 right-0 z-10 p-4 bg-gradient-to-b from-black/80">
                                    <div className="flex gap-1 h-1 mb-2">
                                        {viewingStory.list.map((_, i) => <div key={i} className={`flex-1 rounded-full ${i === viewingStory.index ? 'bg-white animate-progress' : 'bg-white/20'}`}></div>)}
                                    </div>
                                    <div className="flex gap-2 items-center text-white justify-between">
                                        <div className="flex items-center gap-2">
                                            <img src={allUsers[viewingStory.uid]?.avatarUrl} className="w-8 h-8 rounded-full" />
                                            <span className="font-bold">{allUsers[viewingStory.uid]?.displayName}</span>
                                        </div>
                                        <button onClick={() => setViewingStory(null)}><X className="text-white" /></button>
                                    </div>
                                </div>
                                <div className="flex-1 relative">
                                    <img src={viewingStory.list[viewingStory.index].imageUrl} className="w-full h-full object-cover" />
                                </div>

                                <div className="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/90 flex items-center justify-between gap-4">
                                    {viewingStory.uid === user.uid ? (
                                        <>
                                            <button onClick={() => toggleViewers(viewingStory.list[viewingStory.index])} className="flex items-center gap-2 text-white/80 hover:text-white">
                                                <Eye size={20} /> <span className="text-sm">{viewingStory.list[viewingStory.index].viewers?.length || 0}</span>
                                            </button>
                                            <button onClick={deleteStory} className="text-red-400 hover:text-red-300"><Trash2 size={20} /></button>
                                        </>
                                    ) : (
                                        <div className="flex-1 flex gap-2">
                                            <input
                                                className="flex-1 bg-white/10 rounded-full px-4 py-2 text-white outline-none placeholder-white/50 border border-white/10"
                                                placeholder="Odpovědět..."
                                                value={storyReply}
                                                onChange={e => setStoryReply(e.target.value)}
                                                onKeyDown={e => e.key === 'Enter' && replyToStory()}
                                            />
                                            <button onClick={replyToStory} className="p-2 bg-[var(--accent)] rounded-full text-white"><Send size={18} /></button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [allUsers, setAllUsers] = useState({});
            const [notifications, setNotifications] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                let unsubSnapshot = null;
                const unsubAuth = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        if (unsubSnapshot) unsubSnapshot();
                        const userDocRef = doc(db, 'artifacts', _appId, 'public', 'data', 'users', u.uid);
                        unsubSnapshot = onSnapshot(userDocRef, async (docSnap) => {
                            if (docSnap.exists()) {
                                setUser({ ...docSnap.data(), isVerified: u.emailVerified });
                            } else {
                                await setDoc(userDocRef, {
                                    uid: u.uid, email: u.email, displayName: u.displayName || u.email.split('@')[0],
                                    friendCode: generateFriendCode(), avatarUrl: getAvatar(u.uid),
                                    status: 'online', friends: [], blocked: [], bio: "Welcome to NexTalk",
                                    theme: 'dark', joinedAt: serverTimestamp()
                                });
                            }
                            setLoading(false);
                        });
                    } else {
                        if (unsubSnapshot) unsubSnapshot();
                        setUser(null);
                        setLoading(false);
                        window.location.href = '../auth/login.html';
                    }
                });
                return () => { unsubAuth(); if (unsubSnapshot) unsubSnapshot(); };
            }, []);

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', _appId, 'public', 'data', 'users'), s => { const m = {}; s.forEach(d => m[d.id] = { uid: d.id, ...d.data() }); setAllUsers(m); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', _appId, 'public', 'data', 'friend_requests'), where("to", "==", user.uid), where("status", "==", "pending"));
                return onSnapshot(q, s => setNotifications(s.docs));
            }, [user]);

            if (loading) return <div className="h-screen w-screen bg-[#0f0f13]"></div>;
            if (!user) return null;

            return (
                <div className="flex h-screen overflow-hidden">
                    <ThemeInjector theme={user.theme} customColors={user.customColors} />
                    <nav className="w-20 bg-[var(--bg-secondary)] border-r border-[var(--border)] flex flex-col items-center py-6 gap-6 z-20">
                        <div className="w-12 h-12 bg-gradient-to-tr from-[var(--accent)] to-purple-400 rounded-xl flex items-center justify-center shadow-lg"><Zap className="text-white" /></div>

                        <a href="../feed/feed.html" className="p-3 rounded-xl transition bg-[var(--accent)] text-white"><Hash /></a>

                        <div className="relative">
                            <a href="../friends/friends.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]">
                                <Bell size={24} />
                            </a>
                            {notifications.length > 0 && <div className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-[var(--bg-primary)] animate-pulse" />}
                        </div>

                        <a href="../friends/friends.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Users /></a>
                        <a href="../crews/crews.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Globe /></a>
                        {user.isAdmin && <a href="../admin/admin.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:text-red-500"><Shield /></a>}

                        <div className="mt-auto flex flex-col gap-4">
                            <a href="../settings/settings.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Settings /></a>
                            <button onClick={() => signOut(auth)}><LogOut className="text-[var(--text-secondary)] hover:text-red-400" /></button>
                        </div>
                    </nav>
                    <main className="flex-1 bg-[var(--bg-primary)] overflow-hidden relative">
                        <Feed user={user} allUsers={allUsers} />
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
