<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexTalk | Connected Future</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Config & Theme Engine -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nexus: {
                            bg: 'var(--bg-color)',
                            dark: 'var(--dark-color)', // Elements
                            primary: 'var(--primary-color)',
                            text: 'var(--text-color)',
                            muted: 'var(--muted-color)',
                            danger: '#ef4444',
                            success: '#22c55e'
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'scale-up': 'scaleUp 0.2s ease-out forwards',
                        'progress': 'progress linear forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleUp: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        progress: { '0%': { width: '0%' }, '100%': { width: '100%' } }
                    }
                }
            }
        }
    </script>

    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Default Dark (Requested: Gray bg, Purple Text) */
            --bg-color: #1a1a1a;
            --dark-color: #262626; /* Slightly lighter for cards */
            --primary-color: #7A4DFF;
            --text-color: #7A4DFF; /* Purple text as requested */
            --muted-color: #a1a1aa;
            --bg-gradient: none;
        }
        
        body { 
            background-color: var(--bg-color); 
            background-image: var(--bg-gradient);
            background-size: cover;
            background-attachment: fixed;
            color: var(--text-color); 
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Override specific text colors for readability if needed, or keep everything purple */
        .text-white-override { color: #E4E4E4; } 
        
        .glass { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; opacity: 0.5; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Zap, MessageSquare, Users, Phone, Settings, Hash, Heart, Share2, 
            Send, Plus, Search, Bell, LogOut, MoreVertical, Shield, User,
            Loader2, Video, Mic, Smile, Lock, Moon, Trash2, Ban, X, ArrowLeft,
            UserPlus, Check, XCircle, FileText, Image as ImageIcon, Music, 
            PenTool, Clock, PhoneIncoming, PhoneMissed, Sun, Palette, Layout, Upload
        } from 'lucide-react';

        // --- MOCK SERVICE (Simulace backendu v prohl√≠≈æeƒçi) ---
        const API = {
            login: async (email, password) => {
                await new Promise(r => setTimeout(r, 800));
                // Simulate generated user
                const idStr = Math.floor(Math.random() * 9000) + 1000;
                return { 
                    id: 'usr_'+Date.now(), 
                    username: `NTUSER-${idStr}`, 
                    email: email,
                    friendCode: `#${Math.random().toString(36).substring(2,6).toUpperCase()}`,
                    avatar: `https://api.dicebear.com/7.x/identicon/svg?seed=${email}`,
                    joinedAt: Date.now()
                };
            },
            register: async (email, password) => {
                return API.login(email, password); // Same logic for mock
            }
        };

        // --- COMPONENTS ---

        // 1. ToS Modal
        const ToSModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md animate-fade-in p-4 text-white-override">
                    <div className="glass p-8 rounded-3xl w-full max-w-2xl relative max-h-[90vh] overflow-y-auto border border-nexus-primary/30">
                        <button onClick={onClose} className="absolute top-6 right-6 hover:text-nexus-primary"><X/></button>
                        <h2 className="text-3xl font-bold text-nexus-primary mb-6">Pravidla pou≈æ√≠v√°n√≠ (ToS)</h2>
                        <div className="space-y-4 text-nexus-muted text-sm leading-relaxed">
                            <p><strong>1. Chov√°n√≠:</strong> Respektujte ostatn√≠. NexTalk je bezpeƒçn√Ω prostor.</p>
                            <p><strong>2. Obsah:</strong> Z√°kaz neleg√°ln√≠ho obsahu. Stories miz√≠ po 24h.</p>
                            <p><strong>3. √öƒçet:</strong> Jste zodpovƒõdn√≠ za sv√© heslo.</p>
                        </div>
                        <button onClick={onClose} className="w-full mt-8 bg-nexus-primary py-3 rounded-xl text-white font-bold hover:opacity-90">Souhlas√≠m</button>
                    </div>
                </div>
            );
        };

        // 2. Story Viewer Popup
        const StoryViewer = ({ story, onClose }) => {
            if (!story) return null;
            // Auto close after 5s
            useEffect(() => {
                const t = setTimeout(onClose, 5000);
                return () => clearTimeout(t);
            }, [story]);

            return (
                <div className="fixed inset-0 z-[60] bg-black flex items-center justify-center animate-fade-in">
                    <div className="relative h-full w-full md:w-[400px] md:h-[80vh] bg-gray-900 md:rounded-2xl overflow-hidden flex flex-col">
                        <div className="absolute top-2 left-2 right-2 h-1 bg-white/30 rounded-full overflow-hidden z-20">
                            <div className="h-full bg-nexus-primary animate-progress" style={{animationDuration: '5s'}}></div>
                        </div>
                        <div className="absolute top-6 left-4 flex items-center gap-3 z-20 text-white-override">
                            <img src={story.avatar} className="w-10 h-10 rounded-full border-2 border-nexus-primary"/>
                            <span className="font-bold shadow-black drop-shadow-md">{story.user}</span>
                        </div>
                        <button onClick={onClose} className="absolute top-6 right-4 text-white z-20"><X size={24}/></button>
                        
                        <div className="flex-1 bg-black flex items-center justify-center relative">
                            {story.image ? (
                                <img src={story.image} className="w-full h-full object-cover"/>
                            ) : (
                                <h1 className="text-2xl text-white font-bold p-4 text-center">Story Content</h1>
                            )}
                        </div>
                        
                        {/* Interactions */}
                        <div className="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent flex gap-4 z-20">
                            <input type="text" placeholder="Reagovat..." className="flex-1 bg-transparent border border-white/50 rounded-full px-4 py-2 text-white placeholder-white/70 outline-none"/>
                            <Heart className="text-white hover:text-nexus-primary cursor-pointer"/>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Add Content Modal (File Upload Support)
        const AddContentModal = ({ isOpen, onClose, onPost, user }) => {
            if (!isOpen) return null;
            const [mode, setMode] = useState('story');
            const [postData, setPostData] = useState({ title: '', desc: '', spotify: '' });
            const [preview, setPreview] = useState(null);
            const fileInputRef = useRef(null);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setPreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = () => {
                const content = {
                    id: Date.now(),
                    type: mode,
                    user: user.username,
                    avatar: user.avatar,
                    image: preview,
                    title: postData.title,
                    desc: postData.desc,
                    spotify: postData.spotify,
                    likes: 0,
                    comments: [],
                    duration: 24
                };
                onPost(content);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-scale-up p-4">
                    <div className="bg-nexus-card border border-nexus-primary/20 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                        <div className="flex border-b border-nexus-primary/20">
                            <button onClick={() => setMode('story')} className={`flex-1 py-4 font-bold ${mode === 'story' ? 'bg-nexus-primary text-white-override' : 'text-nexus-muted'}`}>Story</button>
                            <button onClick={() => setMode('post')} className={`flex-1 py-4 font-bold ${mode === 'post' ? 'bg-nexus-primary text-white-override' : 'text-nexus-muted'}`}>P≈ô√≠spƒõvek</button>
                        </div>
                        
                        <div className="p-6 space-y-4 overflow-y-auto">
                            {/* Upload Area */}
                            <div 
                                onClick={() => fileInputRef.current.click()}
                                className="aspect-video bg-nexus-dark rounded-xl border-2 border-dashed border-nexus-muted/50 flex flex-col items-center justify-center text-nexus-muted hover:border-nexus-primary hover:text-nexus-primary cursor-pointer relative overflow-hidden"
                            >
                                <input type="file" ref={fileInputRef} hidden onChange={handleFileChange} accept="image/*"/>
                                {preview ? (
                                    <img src={preview} className="w-full h-full object-cover"/>
                                ) : (
                                    <>
                                        <Upload size={32} className="mb-2"/>
                                        <span className="text-sm">Klikni pro nahr√°n√≠ fotky</span>
                                    </>
                                )}
                            </div>

                            {mode === 'post' && (
                                <>
                                    <input type="text" placeholder="Nadpis" className="w-full bg-nexus-dark p-3 rounded-xl border border-nexus-primary/20 outline-none text-nexus-text placeholder-nexus-muted" onChange={e => setPostData({...postData, title: e.target.value})}/>
                                    <textarea placeholder="Popis..." className="w-full bg-nexus-dark p-3 rounded-xl border border-nexus-primary/20 outline-none text-nexus-text h-24 resize-none placeholder-nexus-muted" onChange={e => setPostData({...postData, desc: e.target.value})}></textarea>
                                    <div className="relative">
                                        <Music size={16} className="absolute left-3 top-3.5 text-[#1DB954]"/>
                                        <input type="text" placeholder="Spotify skladba..." className="w-full bg-nexus-dark p-3 pl-10 rounded-xl border border-nexus-primary/20 outline-none text-nexus-text placeholder-nexus-muted" onChange={e => setPostData({...postData, spotify: e.target.value})}/>
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="p-4 border-t border-nexus-primary/20 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-nexus-muted hover:text-nexus-text">Zru≈°it</button>
                            <button onClick={handleSubmit} className="px-6 py-2 bg-nexus-primary rounded-xl text-white-override font-bold shadow-lg">Publikovat</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Friend Profile Popup
        const FriendProfile = ({ user, onClose }) => {
            if(!user) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-scale-up p-4" onClick={onClose}>
                    <div className="bg-nexus-card border border-nexus-primary/20 rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="h-24 bg-gradient-to-r from-nexus-primary to-blue-600 relative">
                            <button onClick={onClose} className="absolute top-2 right-2 text-white-override hover:bg-black/20 p-1 rounded-full"><X/></button>
                        </div>
                        <div className="px-6 pb-6 -mt-12">
                            <img src={user.avatar} className="w-24 h-24 rounded-full border-4 border-nexus-card bg-nexus-dark mb-2"/>
                            <h2 className="text-xl font-bold text-nexus-text">{user.name}</h2>
                            <p className="text-nexus-muted text-xs mb-4">ID: {user.friendCode || '#????'}</p>
                            
                            <h3 className="text-xs font-bold text-nexus-muted uppercase border-b border-nexus-primary/20 pb-1 mb-2">Historie Vol√°n√≠</h3>
                            <div className="space-y-2 mb-6 max-h-24 overflow-y-auto">
                                <div className="flex justify-between text-xs text-nexus-text bg-nexus-dark p-2 rounded">
                                    <span className="flex items-center gap-1"><PhoneMissed size={12} className="text-nexus-danger"/> Vƒçera</span>
                                    <span className="text-nexus-muted">Zme≈°k√°no</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <button className="py-2 bg-nexus-primary rounded-lg text-white-override font-bold text-sm">Zpr√°va</button>
                                <button className="py-2 bg-nexus-dark border border-nexus-primary/30 rounded-lg text-nexus-text font-bold text-sm">Volat</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Settings with THEME ENGINE
        const SettingsPanel = ({ user, onUpdateUser }) => {
            const [tab, setTab] = useState('account');
            const [username, setUsername] = useState(user.username);
            
            // Theme State
            const [theme, setTheme] = useState('dark');
            const [customData, setCustomData] = useState({ bg: '#000000', text: '#ffffff', grad1: '#1a1a1a', grad2: '#000000' });

            const applyTheme = (mode) => {
                const root = document.documentElement;
                setTheme(mode);
                if (mode === 'dark') {
                    root.style.setProperty('--bg-color', '#1a1a1a'); // Gray
                    root.style.setProperty('--dark-color', '#262626');
                    root.style.setProperty('--card-color', '#1a1a1a');
                    root.style.setProperty('--text-color', '#7A4DFF'); // Purple text
                    root.style.setProperty('--muted-color', '#a1a1aa');
                    root.style.setProperty('--bg-gradient', 'none');
                } else if (mode === 'light') {
                    root.style.setProperty('--bg-color', '#ffffff');
                    root.style.setProperty('--dark-color', '#f3f4f6');
                    root.style.setProperty('--card-color', '#ffffff');
                    root.style.setProperty('--text-color', '#7A4DFF'); // Purple text
                    root.style.setProperty('--muted-color', '#6b7280');
                    root.style.setProperty('--bg-gradient', 'none');
                } else if (mode === 'custom') {
                    root.style.setProperty('--bg-color', customData.bg);
                    root.style.setProperty('--text-color', customData.text);
                    root.style.setProperty('--card-color', customData.bg); // Fallback
                    root.style.setProperty('--dark-color', 'rgba(255,255,255,0.1)');
                    root.style.setProperty('--bg-gradient', `linear-gradient(135deg, ${customData.grad1}, ${customData.grad2})`);
                }
            };

            useEffect(() => { if (theme === 'custom') applyTheme('custom'); }, [customData]);

            return (
                <div className="flex flex-col md:flex-row h-full gap-6 animate-fade-in">
                    <div className="w-full md:w-48 flex flex-col gap-1 md:border-r border-nexus-primary/20 md:pr-4">
                        <button onClick={() => setTab('account')} className={`text-left px-4 py-2 rounded-lg font-bold ${tab==='account'?'bg-nexus-primary text-white-override':'text-nexus-muted'}`}>√öƒçet</button>
                        <button onClick={() => setTab('appearance')} className={`text-left px-4 py-2 rounded-lg font-bold ${tab==='appearance'?'bg-nexus-primary text-white-override':'text-nexus-muted'}`}>Vzhled</button>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                        {tab === 'account' && (
                            <div className="space-y-4 max-w-md">
                                <h2 className="text-2xl font-bold mb-4">√öƒçet</h2>
                                <div className="bg-nexus-dark p-4 rounded-xl">
                                    <label className="text-xs font-bold text-nexus-muted uppercase block mb-1">Jm√©no</label>
                                    <input value={username} onChange={e => setUsername(e.target.value)} className="w-full bg-transparent border-b border-nexus-primary/30 outline-none text-nexus-text"/>
                                    <p className="text-[10px] text-nexus-muted mt-1">Lze mƒõnit 1x t√Ωdnƒõ. Bez mezer.</p>
                                </div>
                                <div className="bg-nexus-dark p-4 rounded-xl flex justify-between items-center">
                                    <div>
                                        <div className="text-xs font-bold text-nexus-muted uppercase">Friend Code</div>
                                        <div className="text-lg font-bold">{user.friendCode}</div>
                                    </div>
                                    <Share2 className="text-nexus-primary cursor-pointer"/>
                                </div>
                                <button onClick={() => { if(username.includes(' ')) alert('Bez mezer!'); else onUpdateUser({...user, username}); }} className="bg-nexus-primary text-white-override px-6 py-2 rounded-lg font-bold">Ulo≈æit</button>
                            </div>
                        )}
                        {tab === 'appearance' && (
                            <div className="space-y-6 max-w-md">
                                <h2 className="text-2xl font-bold mb-4">Vzhled</h2>
                                <div className="grid grid-cols-3 gap-2">
                                    <div onClick={() => applyTheme('dark')} className={`p-4 border-2 rounded-xl cursor-pointer text-center font-bold ${theme==='dark'?'border-nexus-primary':'border-nexus-muted/20'}`}>Dark</div>
                                    <div onClick={() => applyTheme('light')} className={`p-4 border-2 rounded-xl cursor-pointer text-center font-bold ${theme==='light'?'border-nexus-primary':'border-nexus-muted/20'}`}>Light</div>
                                    <div onClick={() => applyTheme('custom')} className={`p-4 border-2 rounded-xl cursor-pointer text-center font-bold ${theme==='custom'?'border-nexus-primary':'border-nexus-muted/20'}`}>Custom</div>
                                </div>
                                {theme === 'custom' && (
                                    <div className="bg-nexus-dark p-4 rounded-xl space-y-4">
                                        <div><label className="text-xs font-bold">Pozad√≠ (Solid)</label><input type="color" value={customData.bg} onChange={e => setCustomData({...customData, bg: e.target.value})} className="w-full h-8"/></div>
                                        <div><label className="text-xs font-bold">Text</label><input type="color" value={customData.text} onChange={e => setCustomData({...customData, text: e.target.value})} className="w-full h-8"/></div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div><label className="text-xs font-bold">Gradient 1</label><input type="color" value={customData.grad1} onChange={e => setCustomData({...customData, grad1: e.target.value})} className="w-full h-8"/></div>
                                            <div><label className="text-xs font-bold">Gradient 2</label><input type="color" value={customData.grad2} onChange={e => setCustomData({...customData, grad2: e.target.value})} className="w-full h-8"/></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- HLAVN√ç LOGIKA ---
        const App = () => {
            const [view, setView] = useState('welcome');
            const [user, setUser] = useState(null);
            
            // Data
            const [feed, setFeed] = useState([]); // Posts
            const [stories, setStories] = useState([]);
            const [friends, setFriends] = useState([]); // Empty by default
            const [requests, setRequests] = useState([]); // Friend requests
            
            // UI States
            const [activeTab, setActiveTab] = useState('feed');
            const [showToS, setShowToS] = useState(false);
            const [showAddContent, setShowAddContent] = useState(false);
            const [viewingStory, setViewingStory] = useState(null);
            const [activeChat, setActiveChat] = useState(null);
            const [showRequests, setShowRequests] = useState(false);
            
            // Friend Management
            const [showAddFriend, setShowAddFriend] = useState(false);
            const [friendCodeInput, setFriendCodeInput] = useState('');
            const [menuOpenId, setMenuOpenId] = useState(null); // ID for 3 dots menu
            const [viewingProfile, setViewingProfile] = useState(null);

            // Auth Logic
            const handleLogin = async (email, pass, isRegister) => {
                const u = await API.login(email);
                setUser(u);
                
                // Welcome Post logic for new users
                if (isRegister) {
                    const welcome = {
                        id: 999, user: 'NexTalk Team', avatar: 'https://api.dicebear.com/7.x/initials/svg?seed=NT&backgroundColor=7A4DFF',
                        title: 'V√≠tejte v NexTalk! üíú', desc: 'Dƒõkujeme, ≈æe jste si n√°s vybrali. Jsme platforma budoucnosti. Nebudete toho litovat!',
                        likes: 1337, image: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=800&q=80', comments: []
                    };
                    setFeed([welcome]);
                } else {
                    setFeed([]); // Empty for existing login simulation
                }
                
                setView('dashboard');
            };

            const handleNewPost = (content) => {
                if(content.type === 'story') setStories([...stories, content]);
                else setFeed([content, ...feed]);
            };

            const handleAddFriend = () => {
                if(!friendCodeInput) return;
                // Mock Add
                const newFriend = { id: Date.now(), name: `Friend_${friendCodeInput}`, avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${friendCodeInput}`, status: 'offline', friendCode: friendCodeInput };
                setFriends([...friends, newFriend]);
                setShowAddFriend(false);
                setFriendCodeInput('');
            };

            // Image Upload for Chat
            const chatFileRef = useRef(null);
            const [chatMsgs, setChatMsgs] = useState([]);
            const [chatTxt, setChatTxt] = useState('');
            const handleChatUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setChatMsgs([...chatMsgs, {id: Date.now(), img: reader.result, sender: 'me'}]);
                    reader.readAsDataURL(file);
                }
            };

            if (view === 'welcome') {
                return <WelcomeScreen onLogin={handleLogin} onToS={() => setShowToS(true)} showToS={showToS} onCloseToS={() => setShowToS(false)}/>;
            }

            return (
                <div className="flex h-screen overflow-hidden text-nexus-text font-sans">
                    {/* Sidebar */}
                    <aside className="w-20 md:w-72 bg-nexus-dark border-r border-nexus-primary/10 flex flex-col z-20 shrink-0">
                        <div className="p-6 flex items-center gap-4">
                            <div className="w-10 h-10 bg-nexus-primary rounded-xl flex items-center justify-center shadow-lg"><Zap className="text-white-override"/></div>
                            <span className="font-bold text-xl hidden md:block">NexTalk</span>
                        </div>
                        <nav className="flex-1 px-4 space-y-2 mt-4">
                            {[{id:'feed', icon:Hash, l:'Feed'}, {id:'friends', icon:Users, l:'P≈ô√°tel√©'}, {id:'settings', icon:Settings, l:'Nastaven√≠'}].map(i => (
                                <button key={i.id} onClick={() => {setActiveTab(i.id); setActiveChat(null);}} className={`w-full flex items-center gap-4 p-3 rounded-xl transition-all ${activeTab===i.id?'bg-nexus-primary text-white-override':'hover:bg-nexus-primary/10'}`}>
                                    <i.icon size={24}/> <span className="font-medium hidden md:block">{i.l}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-nexus-primary/10 flex items-center gap-3">
                            <img src={user.avatar} className="w-10 h-10 rounded-full border border-nexus-primary"/>
                            <div className="hidden md:block overflow-hidden flex-1">
                                <div className="font-bold text-sm truncate">{user.username}</div>
                                <div className="text-[10px] text-nexus-muted">{user.friendCode}</div>
                            </div>
                            <button onClick={() => setView('welcome')}><LogOut className="text-nexus-danger hover:scale-110 transition-transform"/></button>
                        </div>
                    </aside>

                    {/* Main */}
                    <main className="flex-1 flex flex-col bg-nexus-bg relative overflow-hidden">
                        {/* Header */}
                        <header className="h-16 glass flex items-center justify-between px-8 z-10 shrink-0">
                            <h2 className="text-xl font-bold capitalize">{activeTab === 'friends' && activeChat ? activeChat.name : activeTab}</h2>
                            <div className="flex gap-4 relative">
                                <button onClick={() => setShowRequests(!showRequests)} className="relative hover:text-nexus-primary transition-colors">
                                    <Bell/>
                                    {requests.length > 0 && <span className="absolute top-0 right-0 w-2 h-2 bg-nexus-primary rounded-full"></span>}
                                </button>
                                {showRequests && (
                                    <div className="absolute right-0 top-10 w-64 bg-nexus-card border border-nexus-primary/20 rounded-xl shadow-xl p-4 z-50 animate-scale-up">
                                        <h3 className="text-xs font-bold uppercase text-nexus-muted mb-2">≈Ω√°dosti</h3>
                                        <div className="text-center text-sm text-nexus-muted">≈Ω√°dn√© nov√© ≈æ√°dosti.</div>
                                    </div>
                                )}
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8" onClick={() => setMenuOpenId(null)}>
                            {/* FEED */}
                            {activeTab === 'feed' && (
                                <div className="max-w-2xl mx-auto space-y-8 pb-20">
                                    <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar items-center">
                                        <div onClick={() => setShowAddContent(true)} className="flex flex-col items-center gap-2 cursor-pointer group shrink-0">
                                            <div className="w-16 h-16 rounded-full border-2 border-dashed border-nexus-muted flex items-center justify-center hover:border-nexus-primary hover:text-nexus-primary bg-nexus-card">
                                                <Plus size={24}/>
                                            </div>
                                            <span className="text-xs font-bold text-nexus-muted">P≈ôidat</span>
                                        </div>
                                        {stories.map(s => (
                                            <div key={s.id} onClick={() => setViewingStory(s)} className="flex flex-col items-center gap-2 cursor-pointer shrink-0">
                                                <div className="w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr from-nexus-primary to-blue-500">
                                                    <div className="w-full h-full rounded-full bg-nexus-bg p-[2px]"><img src={s.avatar} className="w-full h-full rounded-full object-cover"/></div>
                                                </div>
                                                <span className="text-xs font-bold">{s.user}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="space-y-6">
                                        {feed.map(post => (
                                            <div key={post.id} className="bg-nexus-card border border-nexus-primary/10 rounded-2xl overflow-hidden shadow-lg animate-fade-in">
                                                <div className="p-4 flex items-center gap-3">
                                                    <img src={post.avatar} className="w-10 h-10 rounded-full"/>
                                                    <div><div className="font-bold text-sm">{post.user}</div><div className="text-xs text-nexus-muted">Pr√°vƒõ teƒè</div></div>
                                                </div>
                                                <div className="px-4 pb-2"><h3 className="font-bold text-lg">{post.title}</h3><p className="text-sm opacity-80">{post.desc}</p></div>
                                                {post.image && <img src={post.image} className="w-full h-64 object-cover"/>}
                                                <div className="p-4 flex gap-4 border-t border-nexus-primary/10">
                                                    <Heart size={20} className="hover:text-nexus-primary cursor-pointer"/> <span className="text-sm">{post.likes}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* FRIENDS */}
                            {activeTab === 'friends' && (
                                !activeChat ? (
                                    <div>
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-nexus-muted uppercase">Seznam P≈ô√°tel</h3>
                                            <button onClick={() => setShowAddFriend(true)} className="text-nexus-primary text-sm font-bold flex items-center gap-1 hover:underline"><UserPlus size={16}/> P≈ôidat</button>
                                        </div>
                                        
                                        {showAddFriend && (
                                            <div className="mb-6 bg-nexus-dark p-4 rounded-xl flex gap-2 animate-fade-in">
                                                <input value={friendCodeInput} onChange={e => setFriendCodeInput(e.target.value)} placeholder="Zadejte Friend Code (#XXXX)" className="flex-1 bg-transparent border-b border-nexus-primary/50 outline-none text-nexus-text"/>
                                                <button onClick={handleAddFriend} className="bg-nexus-primary text-white-override px-4 py-1 rounded-lg font-bold text-sm">Odeslat</button>
                                            </div>
                                        )}

                                        {friends.length === 0 ? (
                                            <div className="text-center text-nexus-muted mt-10">Zat√≠m nem√°te ≈æ√°dn√© p≈ô√°tele. Pou≈æijte tlaƒç√≠tko "P≈ôidat".</div>
                                        ) : (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {friends.map(f => (
                                                    <div key={f.id} className="bg-nexus-card border border-nexus-primary/10 p-4 rounded-2xl flex items-center gap-3 relative group">
                                                        <img src={f.avatar} className="w-12 h-12 rounded-full bg-nexus-dark"/>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-bold truncate">{f.name}</div>
                                                            <div className="text-xs text-nexus-muted">{f.status}</div>
                                                        </div>
                                                        <button onClick={() => setActiveChat(f)} className="bg-nexus-primary/10 text-nexus-primary px-3 py-1 rounded text-xs font-bold hover:bg-nexus-primary hover:text-white-override">Chat</button>
                                                        <button className="p-2 text-nexus-muted hover:text-nexus-text"><Phone size={16}/></button>
                                                        
                                                        {/* 3 DOTS MENU */}
                                                        <div className="relative">
                                                            <button onClick={(e) => { e.stopPropagation(); setMenuOpenId(menuOpenId === f.id ? null : f.id); }} className="p-2 text-nexus-muted hover:text-nexus-text"><MoreVertical size={16}/></button>
                                                            {menuOpenId === f.id && (
                                                                <div className="absolute right-0 top-full mt-1 w-40 bg-nexus-dark border border-nexus-primary/20 rounded-xl shadow-xl z-50 overflow-hidden" onClick={e => e.stopPropagation()}>
                                                                    <button onClick={() => {setViewingProfile(f); setMenuOpenId(null);}} className="w-full text-left px-4 py-2 text-xs hover:bg-nexus-primary/10 flex items-center gap-2"><User size={12}/> Profil</button>
                                                                    <button className="w-full text-left px-4 py-2 text-xs text-nexus-danger hover:bg-nexus-danger/10 flex items-center gap-2"><Trash2 size={12}/> Smazat</button>
                                                                    <button className="w-full text-left px-4 py-2 text-xs text-nexus-muted hover:bg-white/5 flex items-center gap-2"><Ban size={12}/> Blokovat</button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    /* CHAT WINDOW */
                                    <div className="flex flex-col h-full bg-nexus-card rounded-2xl border border-nexus-primary/10 overflow-hidden animate-fade-in">
                                        <div className="h-14 border-b border-nexus-primary/10 flex items-center justify-between px-4 bg-nexus-dark">
                                            <div className="flex items-center gap-3">
                                                <button onClick={() => setActiveChat(null)}><ArrowLeft/></button>
                                                <img src={activeChat.avatar} className="w-8 h-8 rounded-full"/>
                                                <span className="font-bold">{activeChat.name}</span>
                                            </div>
                                            <div className="flex gap-2 text-nexus-primary"><Phone/><Video/></div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-nexus-card">
                                            {chatMsgs.map(m => (
                                                <div key={m.id} className="flex justify-end">
                                                    {m.img ? <img src={m.img} className="max-w-[70%] rounded-xl border border-nexus-primary"/> : <div className="bg-nexus-primary text-white-override px-4 py-2 rounded-2xl rounded-tr-none max-w-[70%] text-sm">{m.text}</div>}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="p-3 bg-nexus-dark border-t border-nexus-primary/10 flex items-center gap-2">
                                            <input type="file" ref={chatFileRef} hidden onChange={handleChatUpload} accept="image/*"/>
                                            <Plus size={20} className="text-nexus-muted cursor-pointer hover:text-nexus-primary" onClick={() => chatFileRef.current.click()}/>
                                            <input value={chatTxt} onChange={e => setChatTxt(e.target.value)} onKeyDown={e => {if(e.key==='Enter'){setChatMsgs([...chatMsgs, {id: Date.now(), text: chatTxt}]); setChatTxt('');}}} placeholder="Zpr√°va..." className="flex-1 bg-nexus-bg rounded-full px-4 py-2 text-nexus-text outline-none border border-nexus-primary/20"/>
                                            <Send size={20} className="text-nexus-primary cursor-pointer" onClick={() => {if(chatTxt){setChatMsgs([...chatMsgs, {id: Date.now(), text: chatTxt}]); setChatTxt('');}}}/>
                                        </div>
                                    </div>
                                )
                            )}

                            {/* SETTINGS */}
                            {activeTab === 'settings' && <SettingsPanel user={user} onUpdateUser={setUser} />}
                        </div>

                        {/* Modals */}
                        <AddContentModal isOpen={showAddContent} onClose={() => setShowAddContent(false)} onPost={handleNewPost} user={user}/>
                        <StoryViewer story={viewingStory} onClose={() => setViewingStory(null)} />
                        <FriendProfile user={viewingProfile} onClose={() => setViewingProfile(null)} />
                    </main>
                </div>
            );
        };

        // --- WELCOME SCREEN COMPONENT ---
        const WelcomeScreen = ({ onLogin, onToS, showToS, onCloseToS }) => {
            const [mode, setMode] = useState('login');
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, pass, mode === 'register');
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-black relative overflow-hidden text-nexus-text font-sans">
                    <div className="absolute inset-0 bg-gradient-to-br from-indigo-900/20 to-black z-0"></div>
                    <div className="glass p-8 rounded-3xl w-full max-w-md relative z-10 border border-nexus-primary/20 animate-fade-in">
                        <div className="flex justify-center mb-6"><Zap size={48} className="text-nexus-primary"/></div>
                        <h1 className="text-4xl font-black text-center text-white-override mb-8">NexTalk</h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input value={email} onChange={e => setEmail(e.target.value)} type="email" placeholder="Email" className="w-full bg-nexus-dark border border-nexus-primary/20 rounded-xl p-3 text-nexus-text outline-none" required/>
                            <input value={pass} onChange={e => setPass(e.target.value)} type="password" placeholder="Heslo" className="w-full bg-nexus-dark border border-nexus-primary/20 rounded-xl p-3 text-nexus-text outline-none" required/>
                            <button className="w-full bg-nexus-primary py-3 rounded-xl text-white-override font-bold hover:opacity-90">{mode === 'login' ? 'P≈ôihl√°sit se' : 'Vytvo≈ôit √∫ƒçet'}</button>
                        </form>
                        <div className="mt-4 text-center text-xs text-nexus-muted cursor-pointer hover:text-nexus-primary" onClick={() => setMode(mode==='login'?'register':'login')}>
                            {mode === 'login' ? 'Nem√°te √∫ƒçet? Registrovat se' : 'M√°te √∫ƒçet? P≈ôihl√°sit se'}
                        </div>
                        <div className="mt-4 text-center text-[10px] text-nexus-muted uppercase cursor-pointer hover:text-white-override" onClick={onToS}>Pravidla (ToS)</div>
                    </div>
                    <ToSModal isOpen={showToS} onClose={onCloseToS}/>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
