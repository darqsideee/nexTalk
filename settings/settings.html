<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexTalk - Settings</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb, rgba(255, 255, 255, 0.1));
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover, rgba(255, 255, 255, 0.2));
        }

        /* Theme Variables Defaults */
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --accent: #7A4DFF;
            --border: rgba(255, 255, 255, 0.05);
            --msg-me: #7A4DFF;
            --msg-them: #27272a;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
    </style>
</head>

<body class="h-screen overflow-hidden selection:bg-[#7A4DFF] selection:text-white" id="app-body">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            MessageSquare, Users, Settings, Heart, Send, Plus,
            Image as ImageIcon, Search, Bell, LogOut,
            MoreVertical, Phone, Video, X, Zap, Eye, EyeOff,
            Hash, Mail, AlertTriangle, CheckCircle, RefreshCw,
            Camera, ChevronLeft, ChevronRight, Shield,
            User, Lock, Trash2, Ban, Globe, Mic, Volume2, UserPlus,
            Paperclip, MessageCircle, Activity, Skull, Ghost, Speaker
        } from 'lucide-react';

        import { initializeApp } from 'firebase/app';
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            onAuthStateChanged, signOut, sendEmailVerification, sendPasswordResetEmail, updatePassword, updateEmail
        } from 'firebase/auth';
        import {
            getFirestore, collection, doc, setDoc, addDoc, onSnapshot,
            query, orderBy, serverTimestamp, updateDoc, deleteDoc, getDoc, where, arrayUnion, arrayRemove
        } from 'firebase/firestore';

        window.process = { env: { NODE_ENV: 'production' } };

        const firebaseConfig = {
            apiKey: "AIzaSyClqVa0abAGdbWre1SgNQ_LPE3OhFgwqC4",
            authDomain: "nextalk-4cb86.firebaseapp.com",
            projectId: "nextalk-4cb86",
            storageBucket: "nextalk-4cb86.firebasestorage.app",
            messagingSenderId: "894596255124",
            appId: "1:894596255124:web:6fdd8b80b8e96fc9aad381",
            measurementId: "G-M8EDS7KCE2"
        };

        const _appId = 'nextalk-production-v11';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "darqsideee@gmail.com";
        const ADMIN_CODE = "NEXTALKD105";

        const generateFriendCode = () => {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const prefix = Array(3).fill(0).map(() => letters[Math.floor(Math.random() * letters.length)]).join('');
            const suffix = Math.floor(100000 + Math.random() * 900000).toString();
            return `${prefix}-${suffix}`;
        };

        const getAvatar = (uid) => `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}&backgroundColor=b6e3f4`;

        const handleRealFileUpload = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        const ThemeInjector = ({ theme, customColors }) => {
            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'light') {
                    root.style.setProperty('--bg-primary', '#f4f4f5');
                    root.style.setProperty('--bg-secondary', '#ffffff');
                    root.style.setProperty('--bg-tertiary', '#e4e4e7');
                    root.style.setProperty('--text-primary', '#18181b');
                    root.style.setProperty('--text-secondary', '#71717a');
                    root.style.setProperty('--border', 'rgba(0,0,0,0.1)');
                    root.style.setProperty('--scrollbar-thumb', 'rgba(0,0,0,0.2)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#e4e4e7');
                } else if (theme === 'custom' && customColors) {
                    root.style.setProperty('--bg-primary', customColors.bgPrimary);
                    root.style.setProperty('--bg-secondary', customColors.bgSecondary);
                    root.style.setProperty('--bg-tertiary', customColors.bgSecondary + '80');
                    root.style.setProperty('--text-primary', customColors.text);
                    root.style.setProperty('--text-secondary', customColors.text + '99');
                    root.style.setProperty('--accent', customColors.accent);
                    root.style.setProperty('--border', customColors.text + '20');
                    root.style.setProperty('--msg-me', customColors.accent);
                    root.style.setProperty('--msg-them', customColors.bgSecondary + '90');
                } else {
                    root.style.setProperty('--bg-primary', '#0f0f13');
                    root.style.setProperty('--bg-secondary', '#18181b');
                    root.style.setProperty('--bg-tertiary', '#27272a');
                    root.style.setProperty('--text-primary', '#ffffff');
                    root.style.setProperty('--text-secondary', 'rgba(255,255,255,0.6)');
                    root.style.setProperty('--border', 'rgba(255,255,255,0.05)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#27272a');
                }
            }, [theme, customColors]);
            return null;
        };

        const GlassCard = ({ children, className = "", onClick, onContextMenu }) => (
            <div onClick={onClick} onContextMenu={onContextMenu} className={`backdrop-blur-xl bg-[var(--bg-secondary)] border border-[var(--border)] shadow-xl ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, className = "", variant = "primary" }) => {
            const styles = {
                primary: "bg-[var(--accent)] text-white hover:brightness-110",
                secondary: "bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-opacity-80",
                danger: "bg-red-500/20 text-red-500 hover:bg-red-500/30"
            };
            return (
                <button onClick={onClick} className={`px-4 py-2 rounded-xl font-bold transition-all active:scale-95 ${styles[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ type = "text", placeholder, value, onChange, icon: Icon, className = "" }) => (
            <div className="relative w-full">
                {Icon && <Icon className="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] w-5 h-5" />}
                <input
                    type={type}
                    placeholder={placeholder}
                    value={value}
                    onChange={onChange}
                    className={`w-full bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent)] transition-all ${Icon ? 'pl-12' : 'pl-4'} ${className}`}
                />
            </div>
        );

        // SETTINGS VIEW
        const SettingsView = ({ user }) => {
            const [tab, setTab] = useState('appearance');
            const [customColors, setCustomColors] = useState(user.customColors || { bgPrimary: '#000000', bgSecondary: '#111111', text: '#ffffff', accent: '#7A4DFF' });
            const [newName, setNewName] = useState(user.displayName);
            const [newBio, setNewBio] = useState(user.bio || "");
            const [adminCode, setAdminCode] = useState("");
            const [audioDevices, setAudioDevices] = useState({ inputs: [], outputs: [] });
            const [selectedInput, setSelectedInput] = useState("");
            const [selectedOutput, setSelectedOutput] = useState("");

            useEffect(() => {
                navigator.mediaDevices.enumerateDevices().then(devices => {
                    setAudioDevices({
                        inputs: devices.filter(d => d.kind === 'audioinput'),
                        outputs: devices.filter(d => d.kind === 'audiooutput')
                    });
                });
            }, []);

            const saveTheme = async (theme) => { await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { theme }); };
            const saveCustomColors = async () => { await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { theme: 'custom', customColors }); };
            const handleSaveProfile = async () => { await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { displayName: newName, bio: newBio }); alert("Uloženo"); };
            const handleUnblock = async (bid) => { await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { blocked: user.blocked.filter(id => id !== bid) }); };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const mockUrl = await handleRealFileUpload(file);
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { avatarUrl: mockUrl });
            };

            const activateAdmin = async () => {
                if (user.email === ADMIN_EMAIL && adminCode === ADMIN_CODE) {
                    await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', user.uid), { isAdmin: true });
                    alert("Admin Tools Unlocked!");
                    window.location.reload();
                } else {
                    alert("Nesprávný kód nebo email.");
                }
            };

            return (
                <div className="p-8 h-full overflow-y-auto bg-[var(--bg-primary)]">
                    <h2 className="text-2xl font-bold mb-6 text-[var(--text-primary)]">Nastavení</h2>
                    <div className="flex gap-6 min-h-[400px]">
                        <div className="w-1/3 border-r border-[var(--border)] space-y-2">
                            {['appearance', 'account', 'voice', 'security', 'blocked'].map(t => (
                                <button key={t} onClick={() => setTab(t)} className={`w-full text-left px-4 py-3 rounded-xl transition ${tab === t ? 'bg-[var(--accent)] text-white' : 'hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)]'}`}>
                                    {t === 'appearance' ? 'Vzhled' : t === 'account' ? 'Účet' : t === 'voice' ? 'Hlas a Video' : t === 'security' ? 'Bezpečnost' : 'Blokovaní'}
                                </button>
                            ))}
                        </div>
                        <div className="flex-1 space-y-6">
                            {tab === 'appearance' && (
                                <>
                                    <h3 className="font-bold mb-2 text-[var(--text-primary)]">Režim</h3>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div onClick={() => saveTheme('dark')} className={`h-20 bg-[#0f0f13] border-2 ${user.theme === 'dark' ? 'border-[var(--accent)]' : 'border-transparent'} rounded-xl flex items-center justify-center cursor-pointer text-white`}>Dark</div>
                                        <div onClick={() => saveTheme('light')} className={`h-20 bg-[#f4f4f5] border-2 ${user.theme === 'light' ? 'border-[var(--accent)]' : 'border-transparent'} rounded-xl flex items-center justify-center cursor-pointer text-black`}>Light</div>
                                        <div onClick={() => saveTheme('custom')} className={`h-20 bg-gradient-to-br from-purple-900 to-black border-2 ${user.theme === 'custom' ? 'border-[var(--accent)]' : 'border-transparent'} rounded-xl flex items-center justify-center cursor-pointer text-white`}>Custom</div>
                                    </div>
                                    {user.theme === 'custom' && (
                                        <div className="space-y-3 mt-4 text-[var(--text-primary)]">
                                            <div><label className="text-xs">Pozadí (Main)</label><input type="color" className="w-full h-8" value={customColors.bgPrimary} onChange={e => setCustomColors({ ...customColors, bgPrimary: e.target.value })} /></div>
                                            <div><label className="text-xs">Panely (Secondary)</label><input type="color" className="w-full h-8" value={customColors.bgSecondary} onChange={e => setCustomColors({ ...customColors, bgSecondary: e.target.value })} /></div>
                                            <div><label className="text-xs">Text</label><input type="color" className="w-full h-8" value={customColors.text} onChange={e => setCustomColors({ ...customColors, text: e.target.value })} /></div>
                                            <div><label className="text-xs">Akcent</label><input type="color" className="w-full h-8" value={customColors.accent} onChange={e => setCustomColors({ ...customColors, accent: e.target.value })} /></div>
                                            <Button onClick={saveCustomColors} className="w-full">Uložit Barvy</Button>
                                        </div>
                                    )}
                                </>
                            )}
                            {tab === 'account' && (
                                <>
                                    <div className="flex items-center gap-4 text-[var(--text-primary)]">
                                        <div className="relative group cursor-pointer">
                                            <img src={user.avatarUrl} className="w-20 h-20 rounded-full object-cover border-2 border-[var(--border)]" />
                                            <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><Camera size={20} className="text-white" /></div>
                                            <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFileChange} />
                                        </div>
                                        <div><div className="font-bold text-lg">{user.displayName}</div><div className="text-xs text-[var(--accent)] font-mono">{user.friendCode}</div></div>
                                    </div>
                                    <Input value={newName} onChange={e => setNewName(e.target.value)} placeholder="Jméno" />
                                    <textarea className="w-full bg-[var(--bg-tertiary)] rounded-xl p-3 text-[var(--text-primary)] border border-[var(--border)] h-24 outline-none" value={newBio} onChange={e => setNewBio(e.target.value)} placeholder="Bio..." />
                                    <Button onClick={handleSaveProfile}>Uložit</Button>
                                </>
                            )}
                            {tab === 'voice' && (
                                <div className="space-y-6 text-[var(--text-primary)]">
                                    <div>
                                        <h3 className="font-bold mb-2 flex items-center gap-2"><Mic size={18} /> Vstupní zařízení</h3>
                                        <select className="w-full bg-[var(--bg-tertiary)] p-3 rounded-xl border border-[var(--border)] outline-none" value={selectedInput} onChange={e => setSelectedInput(e.target.value)}>
                                            {audioDevices.inputs.map(d => <option key={d.deviceId} value={d.deviceId}>{d.label || `Microphone ${d.deviceId.slice(0, 5)}...`}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <h3 className="font-bold mb-2 flex items-center gap-2"><Speaker size={18} /> Výstupní zařízení</h3>
                                        <select className="w-full bg-[var(--bg-tertiary)] p-3 rounded-xl border border-[var(--border)] outline-none" value={selectedOutput} onChange={e => setSelectedOutput(e.target.value)}>
                                            {audioDevices.outputs.map(d => <option key={d.deviceId} value={d.deviceId}>{d.label || `Speaker ${d.deviceId.slice(0, 5)}...`}</option>)}
                                        </select>
                                    </div>
                                    <div className="p-4 bg-[var(--bg-tertiary)] rounded-xl border border-[var(--border)]">
                                        <h3 className="font-bold mb-2 text-sm">Test mikrofonu</h3>
                                        <div className="w-full h-2 bg-black/50 rounded-full overflow-hidden">
                                            <div className="h-full bg-green-500 w-[0%] animate-pulse"></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {tab === 'security' && (
                                <div className="space-y-4">
                                    <div className="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-sm text-yellow-200"><AlertTriangle size={16} className="inline mr-2" />Zkontroluj SPAM složku!</div>
                                    <Button variant="secondary" className="w-full justify-between">Změnit Email <ChevronRight size={16} /></Button>
                                    <Button variant="secondary" className="w-full justify-between">Změnit Heslo <ChevronRight size={16} /></Button>

                                    {user.email === ADMIN_EMAIL && !user.isAdmin && (
                                        <div className="mt-8 border-t border-[var(--border)] pt-4">
                                            <h3 className="text-sm font-bold text-red-500 uppercase mb-2">Admin Zone</h3>
                                            <div className="flex gap-2">
                                                <Input type="password" placeholder="Admin Kód" value={adminCode} onChange={e => setAdminCode(e.target.value)} />
                                                <Button variant="danger" onClick={activateAdmin}>Aktivovat</Button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            {tab === 'blocked' && (
                                <div>
                                    {user.blocked?.length === 0 && <div className="text-[var(--text-secondary)] text-center py-10">Nikdo není blokován</div>}
                                    {user.blocked?.map(bid => (
                                        <div key={bid} className="flex justify-between items-center p-3 bg-[var(--bg-tertiary)] rounded-xl mb-2 text-[var(--text-primary)]">
                                            <span className="font-mono text-sm">{bid}</span>
                                            <Button variant="secondary" className="py-1 px-3 text-xs" onClick={() => handleUnblock(bid)}>Odblokovat</Button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [allUsers, setAllUsers] = useState({});
            const [notifications, setNotifications] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                let unsubSnapshot = null;
                const unsubAuth = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        if (unsubSnapshot) unsubSnapshot();
                        const userDocRef = doc(db, 'artifacts', _appId, 'public', 'data', 'users', u.uid);
                        unsubSnapshot = onSnapshot(userDocRef, async (docSnap) => {
                            if (docSnap.exists()) {
                                setUser({ ...docSnap.data(), isVerified: u.emailVerified });
                            } else {
                                await setDoc(userDocRef, {
                                    uid: u.uid, email: u.email, displayName: u.displayName || u.email.split('@')[0],
                                    friendCode: generateFriendCode(), avatarUrl: getAvatar(u.uid),
                                    status: 'online', friends: [], blocked: [], bio: "Welcome to NexTalk",
                                    theme: 'dark', joinedAt: serverTimestamp()
                                });
                            }
                            setLoading(false);
                        });
                    } else {
                        if (unsubSnapshot) unsubSnapshot();
                        setUser(null);
                        setLoading(false);
                        window.location.href = '../auth/login.html';
                    }
                });
                return () => { unsubAuth(); if (unsubSnapshot) unsubSnapshot(); };
            }, []);

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', _appId, 'public', 'data', 'users'), s => { const m = {}; s.forEach(d => m[d.id] = { uid: d.id, ...d.data() }); setAllUsers(m); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', _appId, 'public', 'data', 'friend_requests'), where("to", "==", user.uid), where("status", "==", "pending"));
                return onSnapshot(q, s => setNotifications(s.docs));
            }, [user]);

            if (loading) return <div className="h-screen w-screen bg-[#0f0f13]"></div>;
            if (!user) return <AuthScreen onLogin={() => { }} />;

            return (
                <div className="flex h-screen overflow-hidden">
                    <ThemeInjector theme={user.theme} customColors={user.customColors} />
                    <nav className="w-20 bg-[var(--bg-secondary)] border-r border-[var(--border)] flex flex-col items-center py-6 gap-6 z-20">
                        <div className="w-12 h-12 bg-gradient-to-tr from-[var(--accent)] to-purple-400 rounded-xl flex items-center justify-center shadow-lg"><Zap className="text-white" /></div>

                        <a href="../feed/feed.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Hash /></a>

                        <div className="relative">
                            <a href="../friends/friends.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]">
                                <Bell size={24} />
                            </a>
                            {notifications.length > 0 && <div className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-[var(--bg-primary)] animate-pulse" />}
                        </div>

                        <a href="../friends/friends.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Users /></a>
                        <a href="../crews/crews.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Globe /></a>
                        {user.isAdmin && <a href="../admin/admin.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:text-red-500"><Shield /></a>}

                        <div className="mt-auto flex flex-col gap-4">
                            <a href="../settings/settings.html" className="p-3 rounded-xl transition bg-[var(--accent)] text-white"><Settings /></a>
                            <button onClick={() => signOut(auth)}><LogOut className="text-[var(--text-secondary)] hover:text-red-400" /></button>
                        </div>
                    </nav>
                    <main className="flex-1 bg-[var(--bg-primary)] overflow-hidden relative">
                        <SettingsView user={user} />
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
