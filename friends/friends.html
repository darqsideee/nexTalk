<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexTalk - Friends</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb, rgba(255, 255, 255, 0.1));
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover, rgba(255, 255, 255, 0.2));
        }

        .typing-dot {
            animation: bounce 1s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* Theme Variables Defaults */
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --accent: #7A4DFF;
            --border: rgba(255, 255, 255, 0.05);
            --msg-me: #7A4DFF;
            --msg-them: #27272a;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
    </style>
</head>

<body class="h-screen overflow-hidden selection:bg-[#7A4DFF] selection:text-white" id="app-body">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            MessageSquare, Users, Settings, Heart, Send, Plus,
            Image as ImageIcon, Search, Bell, LogOut,
            MoreVertical, Phone, Video, X, Zap, Eye, EyeOff,
            Hash, Mail, AlertTriangle, CheckCircle, RefreshCw,
            Camera, ChevronLeft, ChevronRight, Shield,
            User, Lock, Trash2, Ban, Globe, Mic, Volume2, UserPlus,
            Paperclip, MessageCircle, Activity, Skull, Ghost, MicOff, VolumeX
        } from 'lucide-react';

        import { initializeApp } from 'firebase/app';
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            onAuthStateChanged, signOut, sendEmailVerification, sendPasswordResetEmail, updatePassword, updateEmail
        } from 'firebase/auth';
        import {
            getFirestore, collection, doc, setDoc, addDoc, onSnapshot,
            query, orderBy, serverTimestamp, updateDoc, deleteDoc, getDoc, where, arrayUnion, arrayRemove
        } from 'firebase/firestore';

        window.process = { env: { NODE_ENV: 'production' } };

        const firebaseConfig = {
            apiKey: "AIzaSyClqVa0abAGdbWre1SgNQ_LPE3OhFgwqC4",
            authDomain: "nextalk-4cb86.firebaseapp.com",
            projectId: "nextalk-4cb86",
            storageBucket: "nextalk-4cb86.firebasestorage.app",
            messagingSenderId: "894596255124",
            appId: "1:894596255124:web:6fdd8b80b8e96fc9aad381",
            measurementId: "G-M8EDS7KCE2"
        };

        const _appId = 'nextalk-production-v11';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const CLOUDFLARE_WORKER_URL = "https://nextalk-mailer.tvojedomena.workers.dev";

        const generateFriendCode = () => {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const prefix = Array(3).fill(0).map(() => letters[Math.floor(Math.random() * letters.length)]).join('');
            const suffix = Math.floor(100000 + Math.random() * 900000).toString();
            return `${prefix}-${suffix}`;
        };

        const getAvatar = (uid) => `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}&backgroundColor=b6e3f4`;

        const handleRealFileUpload = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        const sendNotificationEmail = async (toEmail, subject, title, message) => {
            if (!CLOUDFLARE_WORKER_URL.includes("workers.dev")) return;
            try {
                await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: toEmail, subject, title, message })
                });
            } catch (e) { console.error("Email fail", e); }
        };

        const ThemeInjector = ({ theme, customColors }) => {
            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'light') {
                    root.style.setProperty('--bg-primary', '#f4f4f5');
                    root.style.setProperty('--bg-secondary', '#ffffff');
                    root.style.setProperty('--bg-tertiary', '#e4e4e7');
                    root.style.setProperty('--text-primary', '#18181b');
                    root.style.setProperty('--text-secondary', '#71717a');
                    root.style.setProperty('--border', 'rgba(0,0,0,0.1)');
                    root.style.setProperty('--scrollbar-thumb', 'rgba(0,0,0,0.2)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#e4e4e7');
                } else if (theme === 'custom' && customColors) {
                    root.style.setProperty('--bg-primary', customColors.bgPrimary);
                    root.style.setProperty('--bg-secondary', customColors.bgSecondary);
                    root.style.setProperty('--bg-tertiary', customColors.bgSecondary + '80');
                    root.style.setProperty('--text-primary', customColors.text);
                    root.style.setProperty('--text-secondary', customColors.text + '99');
                    root.style.setProperty('--accent', customColors.accent);
                    root.style.setProperty('--border', customColors.text + '20');
                    root.style.setProperty('--msg-me', customColors.accent);
                    root.style.setProperty('--msg-them', customColors.bgSecondary + '90');
                } else {
                    root.style.setProperty('--bg-primary', '#0f0f13');
                    root.style.setProperty('--bg-secondary', '#18181b');
                    root.style.setProperty('--bg-tertiary', '#27272a');
                    root.style.setProperty('--text-primary', '#ffffff');
                    root.style.setProperty('--text-secondary', 'rgba(255,255,255,0.6)');
                    root.style.setProperty('--border', 'rgba(255,255,255,0.05)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#27272a');
                }
            }, [theme, customColors]);
            return null;
        };

        const GlassCard = ({ children, className = "", onClick, onContextMenu }) => (
            <div onClick={onClick} onContextMenu={onContextMenu} className={`backdrop-blur-xl bg-[var(--bg-secondary)] border border-[var(--border)] shadow-xl ${className}`}>
                {children}
            </div>
        );

        const Modal = ({ onClose, title, children }) => (
            <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                <GlassCard className="w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col rounded-2xl bg-[var(--bg-secondary)]">
                    <div className="p-5 border-b border-[var(--border)] flex justify-between items-center">
                        <h2 className="text-xl font-bold text-[var(--text-primary)]">{title}</h2>
                        <button onClick={onClose} className="p-1 hover:bg-[var(--bg-tertiary)] rounded-full text-[var(--text-primary)]"><X size={20} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto custom-scrollbar text-[var(--text-primary)]">
                        {children}
                    </div>
                </GlassCard>
            </div>
        );

        const Button = ({ children, onClick, className = "", variant = "primary" }) => {
            const styles = {
                primary: "bg-[var(--accent)] text-white hover:brightness-110",
                secondary: "bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-opacity-80",
                danger: "bg-red-500/20 text-red-500 hover:bg-red-500/30"
            };
            return (
                <button onClick={onClick} className={`px-4 py-2 rounded-xl font-bold transition-all active:scale-95 ${styles[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ type = "text", placeholder, value, onChange, icon: Icon, className = "" }) => (
            <div className="relative w-full">
                {Icon && <Icon className="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] w-5 h-5" />}
                <input
                    type={type}
                    placeholder={placeholder}
                    value={value}
                    onChange={onChange}
                    className={`w-full bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent)] transition-all ${Icon ? 'pl-12' : 'pl-4'} ${className}`}
                />
            </div>
        );

        // CALL MANAGER
        const CallManager = ({ user, allUsers }) => {
            const [incomingCall, setIncomingCall] = useState(null);
            const [activeCall, setActiveCall] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const [isDeafened, setIsDeafened] = useState(false);
            const [minimized, setMinimized] = useState(false);
            const audioRef = useRef(null);

            useEffect(() => {
                const q = query(collection(db, 'artifacts', _appId, 'public', 'data', 'calls'), where("to", "==", user.uid), where("status", "==", "ringing"));
                const unsub = onSnapshot(q, snap => {
                    if (!snap.empty) {
                        const callData = { id: snap.docs[0].id, ...snap.docs[0].data() };
                        setIncomingCall(callData);
                        if (audioRef.current) {
                            audioRef.current.play().catch(e => console.log("Audio play failed", e));
                        }
                    } else {
                        setIncomingCall(null);
                        if (audioRef.current) {
                            audioRef.current.pause();
                            audioRef.current.currentTime = 0;
                        }
                    }
                });
                return () => unsub();
            }, [user]);

            const acceptCall = async () => {
                if (!incomingCall) return;
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'calls', incomingCall.id), { status: 'connected' });
                setActiveCall(incomingCall);
                setIncomingCall(null);
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
            };

            const declineCall = async () => {
                if (!incomingCall) return;
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'calls', incomingCall.id), { status: 'rejected' });
                setIncomingCall(null);
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
            };

            const endCall = async () => {
                if (!activeCall) return;
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'calls', activeCall.id), { status: 'ended' });
                setActiveCall(null);
            };

            return (
                <>
                    <audio ref={audioRef} src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" loop />

                    {incomingCall && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                            <GlassCard className="p-8 text-center space-y-6 max-w-sm w-full">
                                <img src={allUsers[incomingCall.from]?.avatarUrl} className="w-24 h-24 rounded-full mx-auto animate-pulse" />
                                <div>
                                    <h3 className="text-2xl font-bold">{allUsers[incomingCall.from]?.displayName}</h3>
                                    <p className="text-[var(--text-secondary)]">Volá...</p>
                                </div>
                                <div className="flex justify-center gap-4">
                                    <button onClick={declineCall} className="p-4 bg-red-500 rounded-full text-white hover:bg-red-600 transition"><Phone size={24} className="rotate-[135deg]" /></button>
                                    <button onClick={acceptCall} className="p-4 bg-green-500 rounded-full text-white hover:bg-green-600 transition animate-bounce"><Phone size={24} /></button>
                                </div>
                            </GlassCard>
                        </div>
                    )}

                    {activeCall && (
                        minimized ? (
                            <div className="fixed bottom-4 right-4 z-50 bg-[var(--bg-secondary)] border border-[var(--border)] p-2 rounded-xl shadow-2xl flex items-center gap-3 cursor-pointer" onClick={() => setMinimized(false)}>
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="font-bold text-sm">{allUsers[activeCall.from === user.uid ? activeCall.to : activeCall.from]?.displayName}</span>
                                <button onClick={(e) => { e.stopPropagation(); endCall(); }} className="p-1 bg-red-500/20 text-red-500 rounded-lg"><Phone size={14} className="rotate-[135deg]" /></button>
                            </div>
                        ) : (
                            <div className="fixed bottom-4 right-4 z-50 w-80">
                                <GlassCard className="p-4 space-y-4">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <span className="font-bold text-sm">Hovor</span>
                                        </div>
                                        <button onClick={() => setMinimized(true)}><ChevronRight className="rotate-90" /></button>
                                    </div>
                                    <div className="text-center py-4">
                                        <img src={allUsers[activeCall.from === user.uid ? activeCall.to : activeCall.from]?.avatarUrl} className="w-20 h-20 rounded-full mx-auto mb-2" />
                                        <div className="font-bold text-lg">{allUsers[activeCall.from === user.uid ? activeCall.to : activeCall.from]?.displayName}</div>
                                        <div className="text-xs text-[var(--text-secondary)]">00:00</div>
                                    </div>
                                    <div className="flex justify-center gap-4">
                                        <button onClick={() => setIsMuted(!isMuted)} className={`p-3 rounded-full transition ${isMuted ? 'bg-red-500/20 text-red-500' : 'bg-[var(--bg-tertiary)] text-[var(--text-primary)]'}`}>{isMuted ? <MicOff size={20} /> : <Mic size={20} />}</button>
                                        <button onClick={() => setIsDeafened(!isDeafened)} className={`p-3 rounded-full transition ${isDeafened ? 'bg-red-500/20 text-red-500' : 'bg-[var(--bg-tertiary)] text-[var(--text-primary)]'}`}>{isDeafened ? <VolumeX size={20} /> : <Volume2 size={20} />}</button>
                                        <button onClick={endCall} className="p-3 bg-red-500 rounded-full text-white hover:bg-red-600 transition"><Phone size={20} className="rotate-[135deg]" /></button>
                                    </div>
                                </GlassCard>
                            </div>
                        )
                    )}
                </>
            );
        };

        // FRIENDS
        const FriendsView = ({ currentUser, allUsers }) => {
            const [friendCode, setFriendCode] = useState("");
            const [showAdd, setShowAdd] = useState(false);
            const [activeChat, setActiveChat] = useState(null);
            const [contextMenu, setContextMenu] = useState(null);
            const [showProfile, setShowProfile] = useState(null);
            const [chatMsgs, setChatMsgs] = useState([]);
            const [text, setText] = useState("");
            const [isTyping, setIsTyping] = useState(false);
            const [reqs, setReqs] = useState([]);

            const friends = currentUser.friends?.map(uid => ({ uid, ...allUsers[uid] })).filter(u => u.displayName) || [];

            // Notifications (Requests)
            useEffect(() => {
                const q = query(collection(db, 'artifacts', _appId, 'public', 'data', 'friend_requests'), where("to", "==", currentUser.uid), where("status", "==", "pending"));
                return onSnapshot(q, s => setReqs(s.docs.map(d => ({ id: d.id, ...d.data() }))));
            }, [currentUser]);

            useEffect(() => {
                if (!activeChat) return;
                const unsub = onSnapshot(query(collection(db, 'artifacts', _appId, 'public', 'data', 'messages'), orderBy('createdAt', 'asc')), snap => {
                    const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(m => (m.from === currentUser.uid && m.to === activeChat.uid) || (m.from === activeChat.uid && m.to === currentUser.uid));
                    setChatMsgs(msgs);
                    if (msgs.length > 0 && msgs[msgs.length - 1].from === currentUser.uid) {
                        setIsTyping(true); setTimeout(() => setIsTyping(false), 2000);
                    }
                });
                return () => unsub();
            }, [activeChat]);

            const sendMessage = async () => {
                if (!text.trim()) return;
                await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'messages'), { from: currentUser.uid, to: activeChat.uid, text, createdAt: serverTimestamp() });
                setText("");
            };

            const sendRequest = async () => {
                const target = Object.values(allUsers).find(u => u.friendCode === friendCode);
                if (target) {
                    await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'friend_requests'), {
                        from: currentUser.uid, to: target.uid, status: 'pending', createdAt: serverTimestamp()
                    });
                    sendNotificationEmail(target.email, "Nová žádost", "Žádost o přátelství", `${currentUser.displayName} si tě chce přidat!`);
                    setShowAdd(false);
                } else alert("Nenalezen");
            };

            const acceptRequest = async (req) => {
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', currentUser.uid), { friends: arrayUnion(req.from) });
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'users', req.from), { friends: arrayUnion(currentUser.uid) });
                await deleteDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'friend_requests', req.id));
            };

            const startCall = async (targetUid) => {
                await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'calls'), {
                    from: currentUser.uid, to: targetUid, status: 'ringing', createdAt: serverTimestamp()
                });
                alert("Vytáčím...");
            };

            if (activeChat) {
                return (
                    <div className="flex flex-col h-full bg-[var(--bg-primary)]">
                        <div className="h-16 border-b border-[var(--border)] flex items-center px-6 gap-4 bg-[var(--bg-secondary)]">
                            <button onClick={() => setActiveChat(null)}><ChevronLeft className="text-[var(--text-secondary)] hover:text-[var(--text-primary)]" /></button>
                            <img src={activeChat.avatarUrl} className="w-10 h-10 rounded-full" />
                            <div className="font-bold text-[var(--text-primary)]">{activeChat.displayName}</div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-2">
                            {chatMsgs.map(m => (
                                <div key={m.id} className={`flex gap-2 items-end ${m.from === currentUser.uid ? 'justify-end' : 'justify-start'}`}>
                                    {m.from !== currentUser.uid && <img src={activeChat.avatarUrl} className="w-6 h-6 rounded-full mb-1" />}
                                    <div className={`px-4 py-2 rounded-2xl max-w-[70%] text-sm ${m.from === currentUser.uid ? 'bg-[var(--msg-me)] text-white' : 'bg-[var(--msg-them)] text-[var(--text-primary)]'}`}>
                                        {m.text}
                                    </div>
                                </div>
                            ))}
                            {isTyping && (
                                <div className="flex gap-2 items-end">
                                    <img src={activeChat.avatarUrl} className="w-6 h-6 rounded-full mb-1" />
                                    <div className="px-4 py-3 rounded-2xl bg-[var(--msg-them)] flex gap-1 items-center h-9">
                                        <div className="w-1.5 h-1.5 bg-[var(--text-secondary)] rounded-full typing-dot"></div>
                                        <div className="w-1.5 h-1.5 bg-[var(--text-secondary)] rounded-full typing-dot"></div>
                                        <div className="w-1.5 h-1.5 bg-[var(--text-secondary)] rounded-full typing-dot"></div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-4"><div className="bg-[var(--bg-tertiary)] rounded-full flex items-center p-1 px-2 border border-[var(--border)]"><input value={text} onChange={e => setText(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} className="bg-transparent flex-1 px-4 py-2 text-[var(--text-primary)] outline-none" placeholder="Zpráva..." /><button onClick={sendMessage} className="p-2 rounded-full bg-[var(--msg-me)] text-white"><Send size={18} /></button></div></div>
                    </div>
                );
            }

            return (
                <div className="p-8 h-full overflow-y-auto bg-[var(--bg-primary)]">
                    <CallManager user={currentUser} allUsers={allUsers} />

                    {/* NOTIFICATIONS PANEL */}
                    {reqs.length > 0 && (
                        <div className="mb-6">
                            <div className="text-xs font-bold text-[var(--accent)] uppercase mb-2 tracking-wider flex items-center gap-2"><Bell size={14} /> Žádosti o přátelství</div>
                            <div className="space-y-2">
                                {reqs.map(r => (
                                    <GlassCard key={r.id} className="p-3 rounded-xl flex justify-between items-center border-l-4 border-l-[var(--accent)]">
                                        <div className="flex items-center gap-3">
                                            <img src={allUsers[r.from]?.avatarUrl} className="w-8 h-8 rounded-full" />
                                            <span className="font-bold text-sm">{allUsers[r.from]?.displayName}</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <Button className="py-1 px-3 text-xs" onClick={() => acceptRequest(r)}>Přijmout</Button>
                                            <button className="text-[var(--text-secondary)] hover:text-red-400" onClick={() => deleteDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'friend_requests', r.id))}><X /></button>
                                        </div>
                                    </GlassCard>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-6">
                        <div className="flex-1 max-w-2xl relative">
                            <Search className="absolute left-3 top-3 text-[var(--text-secondary)] w-5 h-5" />
                            <input placeholder="Hledat konverzace..." className="w-full bg-[var(--bg-secondary)] text-[var(--text-primary)] text-sm rounded-xl pl-10 pr-4 py-3 focus:outline-none border border-[var(--border)] focus:border-[var(--accent)] transition" />
                        </div>
                        <Button onClick={() => setShowAdd(true)} className="ml-4"><UserPlus size={18} className="inline mr-2" /> Přidat</Button>
                    </div>

                    <div className="text-xs font-bold text-[var(--text-secondary)] uppercase mb-4 tracking-wider">Seznam přátel</div>
                    <div className="space-y-2">
                        {friends.map(friend => (
                            <div key={friend.uid} className="bg-[var(--bg-secondary)] border border-[var(--border)] p-4 rounded-xl flex items-center gap-4 hover:border-[var(--accent)] transition group">
                                <div className="relative">
                                    <img src={friend.avatarUrl} className="w-12 h-12 rounded-full bg-[var(--bg-tertiary)]" />
                                    <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-[var(--bg-secondary)]"></div>
                                </div>
                                <div className="flex-1">
                                    <div className="font-bold text-[var(--text-primary)]">{friend.displayName}</div>
                                    <div className="text-xs text-[var(--text-secondary)]">Online</div>
                                </div>
                                <div className="flex items-center gap-4 opacity-80">
                                    <button onClick={() => setActiveChat(friend)} className="text-[var(--accent)] font-bold text-sm hover:underline">Chat</button>
                                    <button onClick={() => startCall(friend.uid)} className="text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] p-2 rounded-full transition"><Phone size={20} /></button>
                                    <div className="relative">
                                        <button onClick={() => setContextMenu(friend.uid)} className="text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><MoreVertical size={20} /></button>
                                        {contextMenu === friend.uid && (
                                            <div className="absolute right-0 top-full mt-2 w-40 bg-[var(--bg-secondary)] border border-[var(--border)] rounded-lg shadow-xl z-50 py-1" onMouseLeave={() => setContextMenu(null)}>
                                                <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-[var(--text-primary)]">Zobrazit profil</button>
                                                <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-red-400">Odstranit přítele</button>
                                                <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-red-400">Zablokovat</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {showAdd && (
                        <Modal title="Přidat přítele" onClose={() => setShowAdd(false)}>
                            <div className="space-y-4">
                                <div className="bg-[var(--bg-tertiary)] p-4 rounded text-center"><div className="text-sm text-[var(--text-secondary)]">Tvůj kód</div><div className="text-xl font-mono text-[var(--accent)]">{currentUser.friendCode}</div></div>
                                <Input placeholder="Kód přítele (ABC-012345)" value={friendCode} onChange={e => setFriendCode(e.target.value)} />
                                <Button onClick={sendRequest} className="w-full">Odeslat žádost</Button>
                            </div>
                        </Modal>
                    )}

                    {showProfile && (
                        <Modal title="Profil" onClose={() => setShowProfile(null)}>
                            <div className="text-center">
                                <img src={showProfile.avatarUrl} className="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-[var(--bg-tertiary)]" />
                                <h2 className="text-xl font-bold text-[var(--text-primary)]">{showProfile.displayName}</h2>
                                <div className="text-[var(--text-secondary)] font-mono mb-4">{showProfile.friendCode}</div>
                                <p className="bg-[var(--bg-tertiary)] p-3 rounded-xl text-[var(--text-primary)]">{showProfile.bio || "Žádné bio."}</p>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [allUsers, setAllUsers] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                let unsubSnapshot = null;
                const unsubAuth = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        if (unsubSnapshot) unsubSnapshot();
                        const userDocRef = doc(db, 'artifacts', _appId, 'public', 'data', 'users', u.uid);
                        unsubSnapshot = onSnapshot(userDocRef, async (docSnap) => {
                            if (docSnap.exists()) {
                                setUser({ ...docSnap.data(), isVerified: u.emailVerified });
                            } else {
                                await setDoc(userDocRef, {
                                    uid: u.uid, email: u.email, displayName: u.displayName || u.email.split('@')[0],
                                    friendCode: generateFriendCode(), avatarUrl: getAvatar(u.uid),
                                    status: 'online', friends: [], blocked: [], bio: "Welcome to NexTalk",
                                    theme: 'dark', joinedAt: serverTimestamp()
                                });
                            }
                            setLoading(false);
                        });
                    } else {
                        if (unsubSnapshot) unsubSnapshot();
                        setUser(null);
                        setLoading(false);
                        window.location.href = '../auth/login.html';
                    }
                });
                return () => { unsubAuth(); if (unsubSnapshot) unsubSnapshot(); };
            }, []);

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', _appId, 'public', 'data', 'users'), s => { const m = {}; s.forEach(d => m[d.id] = { uid: d.id, ...d.data() }); setAllUsers(m); });
                return () => unsub();
            }, []);

            if (loading) return <div className="h-screen w-screen bg-[#0f0f13]"></div>;
            if (!user) return null;

            return (
                <div className="flex h-screen overflow-hidden">
                    <ThemeInjector theme={user.theme} customColors={user.customColors} />
                    <nav className="w-20 bg-[var(--bg-secondary)] border-r border-[var(--border)] flex flex-col items-center py-6 gap-6 z-20">
                        <div className="w-12 h-12 bg-gradient-to-tr from-[var(--accent)] to-purple-400 rounded-xl flex items-center justify-center shadow-lg"><Zap className="text-white" /></div>

                        <a href="../feed/feed.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Hash /></a>

                        <a href="../friends/friends.html" className="p-3 rounded-xl transition bg-[var(--accent)] text-white"><Users /></a>
                        <a href="../crews/crews.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Globe /></a>
                        {user.isAdmin && <a href="../admin/admin.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:text-red-500"><Shield /></a>}

                        <div className="mt-auto flex flex-col gap-4">
                            <a href="../settings/settings.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Settings /></a>
                            <button onClick={() => signOut(auth)}><LogOut className="text-[var(--text-secondary)] hover:text-red-400" /></button>
                        </div>
                    </nav>
                    <main className="flex-1 bg-[var(--bg-primary)] overflow-hidden relative">
                        <FriendsView currentUser={user} allUsers={allUsers} />
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
