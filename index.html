<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexTalk | Connected Future</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nexus: {
                            bg: 'var(--bg-color)',
                            dark: 'var(--dark-color)',
                            card: 'var(--card-color)',
                            primary: 'var(--primary-color)',
                            text: 'var(--text-color)',
                            muted: 'var(--muted-color)',
                            danger: '#ef4444',
                            success: '#22c55e'
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'scale-up': 'scaleUp 0.2s ease-out forwards',
                        'progress': 'progress linear forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleUp: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        progress: { '0%': { width: '0%' }, '100%': { width: '100%' } }
                    }
                }
            }
        }
    </script>

    <!-- Import Map (Fixed Versions) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1a1a1a;
            --dark-color: #262626;
            --card-color: #262626;
            --primary-color: #7A4DFF;
            --text-color: #7A4DFF;
            --muted-color: #a1a1aa;
            --bg-image: none;
        }
        
        /* Helper for readable white text regardless of theme */
        .text-readable { color: #E4E4E4; }

        body { 
            background-color: var(--bg-color); 
            background-image: var(--bg-image);
            background-size: cover;
            background-attachment: fixed;
            color: var(--text-color); 
            transition: all 0.3s ease;
        }
        
        .glass { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; opacity: 0.5; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Zap, MessageSquare, Users, Phone, Settings, Hash, Heart, Share2, 
            Send, Plus, Search, Bell, LogOut, MoreVertical, Shield, User,
            Loader2, Video, Mic, Smile, Lock, Moon, Trash2, Ban, X, ArrowLeft,
            UserPlus, Check, XCircle, FileText, Image as ImageIcon, Music, 
            PenTool, Clock, Eye, PhoneIncoming, PhoneOutgoing, PhoneMissed, Sun, 
            Palette, Layout, Mail, Key, Upload
        } from 'lucide-react';

        // --- API HANDLER ---
        const WORKER_URL = "https://komunikejsn.darqsideee.workers.dev";
        
        const apiFetch = async (endpoint, options = {}) => {
            try {
                const res = await fetch(`${WORKER_URL}${endpoint}`, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', ...options.headers }
                });
                if (!res.ok) throw new Error("API Error");
                return await res.json();
            } catch (e) {
                console.warn("Using Local Fallback due to API error/offline");
                return null;
            }
        };

        // --- COMPONENTS ---

        // 1. ToS Modal
        const ToSModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md animate-fade-in p-4 text-readable">
                    <div className="glass p-8 rounded-3xl w-full max-w-2xl relative max-h-[90vh] overflow-y-auto border border-nexus-primary/30">
                        <button onClick={onClose} className="absolute top-6 right-6 hover:text-nexus-primary"><X/></button>
                        <h2 className="text-3xl font-bold text-nexus-primary mb-6">Pravidla pou쮂셨치n칤 (ToS)</h2>
                        <div className="space-y-4 text-nexus-muted text-sm leading-relaxed">
                            <p><strong>1. Chov치n칤:</strong> Respektujte ostatn칤. NexTalk je bezpe캜n칳 prostor.</p>
                            <p><strong>2. Obsah:</strong> Z치kaz neleg치ln칤ho obsahu. Stories miz칤 po 24h.</p>
                            <p><strong>3. 칔캜et:</strong> Jste zodpov캩dn칤 za sv칠 heslo.</p>
                        </div>
                        <button onClick={onClose} className="w-full mt-8 bg-nexus-primary py-3 rounded-xl text-white font-bold hover:opacity-90">Souhlas칤m</button>
                    </div>
                </div>
            );
        };

        // 2. Story Viewer
        const StoryViewer = ({ story, onClose }) => {
            if (!story) return null;
            
            // Auto close timer
            useEffect(() => {
                const t = setTimeout(onClose, 5000);
                return () => clearTimeout(t);
            }, [story]);

            return (
                <div className="fixed inset-0 z-[60] bg-black flex items-center justify-center animate-fade-in">
                    <div className="relative h-full w-full md:w-[400px] md:h-[80vh] bg-gray-900 md:rounded-2xl overflow-hidden flex flex-col">
                        <div className="absolute top-2 left-2 right-2 h-1 bg-white/30 rounded-full overflow-hidden z-20">
                            <div className="h-full bg-nexus-primary animate-progress" style={{animationDuration: '5s'}}></div>
                        </div>
                        <div className="absolute top-6 left-4 flex items-center gap-3 z-20 text-white">
                            <img src={story.avatar} className="w-10 h-10 rounded-full border-2 border-nexus-primary"/>
                            <span className="font-bold shadow-black drop-shadow-md">{story.user}</span>
                        </div>
                        <button onClick={onClose} className="absolute top-6 right-4 text-white z-20"><X size={24}/></button>
                        
                        <div className="flex-1 bg-black flex items-center justify-center relative">
                            {story.image ? (
                                <img src={story.image} className="w-full h-full object-cover"/>
                            ) : (
                                <div className="p-8 text-center">
                                    <h1 className="text-2xl text-white font-bold">{story.title || "Story"}</h1>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Add Content Modal
        const AddContentModal = ({ isOpen, onClose, onPost, user }) => {
            if (!isOpen) return null;
            const [mode, setMode] = useState('story');
            const [postData, setPostData] = useState({ title: '', desc: '', spotify: '' });
            const [preview, setPreview] = useState(null);
            const fileRef = useRef(null);

            const handleFile = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setPreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = () => {
                const content = {
                    id: Date.now(),
                    type: mode,
                    user: user.username,
                    avatar: user.avatar,
                    image: preview,
                    ...postData,
                    likes: 0,
                    comments: [],
                    duration: 24
                };
                onPost(content);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-scale-up p-4 text-readable">
                    <div className="bg-nexus-card border border-white/10 rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="flex border-b border-white/10">
                            <button onClick={() => setMode('story')} className={`flex-1 py-4 font-bold ${mode==='story'?'bg-nexus-primary text-white':'text-nexus-muted'}`}>Story</button>
                            <button onClick={() => setMode('post')} className={`flex-1 py-4 font-bold ${mode==='post'?'bg-nexus-primary text-white':'text-nexus-muted'}`}>P콏칤sp캩vek</button>
                        </div>
                        <div className="p-6 space-y-4 overflow-y-auto">
                            <div onClick={() => fileRef.current.click()} className="aspect-video bg-nexus-dark rounded-xl border-2 border-dashed border-white/10 flex flex-col items-center justify-center cursor-pointer hover:border-nexus-primary relative overflow-hidden">
                                <input type="file" ref={fileRef} hidden onChange={handleFile} accept="image/*"/>
                                {preview ? <img src={preview} className="w-full h-full object-cover"/> : <><ImageIcon className="mb-2 text-nexus-muted"/><span className="text-sm text-nexus-muted">Nahr치t obr치zek</span></>}
                            </div>
                            {mode === 'post' && (
                                <>
                                    <input placeholder="Nadpis" className="w-full bg-nexus-dark p-3 rounded-xl outline-none text-readable" onChange={e => setPostData({...postData, title: e.target.value})}/>
                                    <textarea placeholder="Popis..." className="w-full bg-nexus-dark p-3 rounded-xl outline-none text-readable h-24 resize-none" onChange={e => setPostData({...postData, desc: e.target.value})}/>
                                    <div className="relative">
                                        <Music size={16} className="absolute left-3 top-3.5 text-[#1DB954]"/>
                                        <input placeholder="Spotify skladba..." className="w-full bg-nexus-dark p-3 pl-10 rounded-xl outline-none text-readable" onChange={e => setPostData({...postData, spotify: e.target.value})}/>
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="p-4 border-t border-white/10 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-nexus-muted">Zru코it</button>
                            <button onClick={handleSubmit} className="px-6 py-2 bg-nexus-primary rounded-xl text-white font-bold">Odeslat</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Friend Profile Popup
        const FriendProfile = ({ user, onClose }) => {
            if(!user) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-scale-up p-4" onClick={onClose}>
                    <div className="bg-nexus-card border border-nexus-primary/20 rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="h-24 bg-gradient-to-r from-nexus-primary to-blue-600 relative">
                            <button onClick={onClose} className="absolute top-2 right-2 text-white hover:bg-black/20 p-1 rounded-full"><X/></button>
                        </div>
                        <div className="px-6 pb-6 -mt-12">
                            <img src={user.avatar} className="w-24 h-24 rounded-full border-4 border-nexus-card bg-nexus-dark mb-2"/>
                            <h2 className="text-xl font-bold text-nexus-text">{user.name}</h2>
                            <p className="text-nexus-muted text-xs mb-4">ID: {user.friendCode || '#????'}</p>
                            
                            <h3 className="text-xs font-bold text-nexus-muted uppercase border-b border-nexus-primary/20 pb-1 mb-2">Historie Vol치n칤</h3>
                            <div className="space-y-2 mb-6 max-h-24 overflow-y-auto">
                                <div className="flex justify-between text-xs text-nexus-text bg-nexus-dark p-2 rounded">
                                    <span className="flex items-center gap-1"><PhoneMissed size={12} className="text-nexus-danger"/> V캜era</span>
                                    <span className="text-nexus-muted">Zme코k치no</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <button className="py-2 bg-nexus-primary rounded-lg text-white font-bold text-sm">Zpr치va</button>
                                <button className="py-2 bg-nexus-dark border border-nexus-primary/30 rounded-lg text-nexus-text font-bold text-sm">Volat</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Settings Panel (Theme Engine)
        const SettingsPanel = ({ user, onUpdateUser }) => {
            const [tab, setTab] = useState('account');
            const [username, setUsername] = useState(user.username);
            const [theme, setTheme] = useState('dark');
            const [grad1, setGrad1] = useState('#1a1a1a');
            const [grad2, setGrad2] = useState('#000000');

            const applyTheme = (mode) => {
                const root = document.documentElement;
                setTheme(mode);
                if(mode === 'dark') {
                    root.style.setProperty('--bg-color', '#1a1a1a');
                    root.style.setProperty('--dark-color', '#262626');
                    root.style.setProperty('--card-color', '#262626');
                    root.style.setProperty('--text-color', '#7A4DFF');
                    root.style.setProperty('--bg-image', 'none');
                } else if (mode === 'light') {
                    root.style.setProperty('--bg-color', '#ffffff');
                    root.style.setProperty('--dark-color', '#f3f4f6');
                    root.style.setProperty('--card-color', '#ffffff');
                    root.style.setProperty('--text-color', '#7A4DFF');
                    root.style.setProperty('--bg-image', 'none');
                } else { // Custom
                    root.style.setProperty('--bg-color', '#000000');
                    root.style.setProperty('--card-color', 'rgba(0,0,0,0.5)');
                    root.style.setProperty('--bg-image', `linear-gradient(135deg, ${grad1}, ${grad2})`);
                }
            };

            useEffect(() => { if(theme === 'custom') applyTheme('custom'); }, [grad1, grad2]);

            return (
                <div className="flex flex-col md:flex-row h-full gap-6 animate-fade-in text-readable">
                    <div className="w-full md:w-60 flex flex-col gap-1 md:border-r border-nexus-primary/20 md:pr-4">
                        <button onClick={() => setTab('account')} className={`text-left px-4 py-3 rounded-xl font-bold ${tab==='account'?'bg-nexus-primary text-white':'text-nexus-muted'}`}>칔캜et</button>
                        <button onClick={() => setTab('appearance')} className={`text-left px-4 py-3 rounded-xl font-bold ${tab==='appearance'?'bg-nexus-primary text-white':'text-nexus-muted'}`}>Vzhled</button>
                    </div>
                    <div className="flex-1">
                        {tab === 'account' && (
                            <div className="space-y-4 max-w-md">
                                <h2 className="text-2xl font-bold text-nexus-primary">칔캜et</h2>
                                <div className="bg-nexus-dark p-4 rounded-xl">
                                    <label className="text-xs text-nexus-muted uppercase font-bold">Jm칠no (Zm캩na 1x t칳dn캩)</label>
                                    <input value={username} onChange={e => !e.target.value.includes(' ') && setUsername(e.target.value)} className="w-full bg-transparent border-b border-nexus-primary/30 py-2 outline-none text-readable"/>
                                </div>
                                <div className="bg-nexus-dark p-4 rounded-xl flex justify-between">
                                    <span className="text-xs text-nexus-muted uppercase font-bold">Friend Code</span>
                                    <span className="font-bold text-nexus-primary">{user.friendCode}</span>
                                </div>
                                <button onClick={() => onUpdateUser({...user, username})} className="bg-nexus-primary px-6 py-2 rounded-xl text-white font-bold">Ulo쬴t</button>
                            </div>
                        )}
                        {tab === 'appearance' && (
                            <div className="space-y-4 max-w-md">
                                <h2 className="text-2xl font-bold text-nexus-primary">Vzhled</h2>
                                <div className="grid grid-cols-3 gap-2">
                                    {['dark', 'light', 'custom'].map(m => (
                                        <div key={m} onClick={() => applyTheme(m)} className={`p-4 border-2 rounded-xl cursor-pointer text-center font-bold capitalize ${theme===m?'border-nexus-primary bg-nexus-primary/10':'border-white/10'}`}>{m}</div>
                                    ))}
                                </div>
                                {theme === 'custom' && (
                                    <div className="bg-nexus-dark p-4 rounded-xl space-y-2">
                                        <label className="text-xs font-bold text-nexus-muted uppercase">Gradient Pozad칤</label>
                                        <div className="flex gap-2">
                                            <input type="color" value={grad1} onChange={e => setGrad1(e.target.value)} className="w-full h-8"/>
                                            <input type="color" value={grad2} onChange={e => setGrad2(e.target.value)} className="w-full h-8"/>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- DASHBOARD ---
        const Dashboard = ({ user, onLogout }) => {
            const [activeTab, setActiveTab] = useState('feed');
            const [activeChat, setActiveChat] = useState(null);
            
            const [posts, setPosts] = useState([]);
            const [stories, setStories] = useState([]);
            const [friends, setFriends] = useState([]);
            
            const [showAddContent, setShowAddContent] = useState(false);
            const [viewingStory, setViewingStory] = useState(null);
            const [showAddFriend, setShowAddFriend] = useState(false);
            const [friendCode, setFriendCode] = useState('');
            const [showRequests, setShowRequests] = useState(false);
            const [chatMsgs, setChatMsgs] = useState([]);
            const chatFileRef = useRef(null);

            // Fetch Feed logic
            useEffect(() => {
                const load = async () => {
                    const data = await apiFetch('/api/feed');
                    // Pokud backend vr치t칤 data, pou쬴jeme je. Jinak empty.
                    if(data) setPosts(data);
                    
                    // Welcome post fallback pro "Mock" user session
                    if(!data && posts.length === 0) {
                        setPosts([{
                            id: 999, user: 'NexTalk Team', avatar: 'https://api.dicebear.com/7.x/initials/svg?seed=NT&backgroundColor=7A4DFF',
                            title: 'V칤tej v NexTalk! 游눞', desc: 'D캩kujeme, 쬰 jsi se p콏idal. Jsme budoucnost komunikace. Nebude코 toho litovat!',
                            likes: 1337, image: 'https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?w=800&q=80', comments: []
                        }]);
                    }
                };
                load();
            }, []);

            const handleNewPost = (content) => {
                if(content.type === 'story') setStories([...stories, content]);
                else setPosts([content, ...posts]);
            };

            const handleAddFriend = () => {
                if(!friendCode) return;
                setFriends([...friends, { 
                    id: Date.now(), 
                    name: `Friend ${friendCode}`, 
                    avatar: `https://api.dicebear.com/7.x/identicon/svg?seed=${friendCode}`, 
                    status: 'offline', 
                    friendCode 
                }]);
                setShowAddFriend(false);
                setFriendCode('');
            };

            const handleChatUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setChatMsgs([...chatMsgs, {id: Date.now(), image: reader.result, sender: 'me'}]);
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="flex h-screen overflow-hidden font-sans">
                    {/* Sidebar */}
                    <aside className="w-20 md:w-72 bg-nexus-dark border-r border-nexus-primary/10 flex flex-col z-20 shrink-0">
                        <div className="p-6 flex items-center gap-4">
                            <Zap className="text-nexus-primary" size={28}/>
                            <span className="font-bold text-xl hidden md:block text-nexus-primary">NexTalk</span>
                        </div>
                        <nav className="flex-1 px-4 space-y-2 mt-4">
                            {[{id:'feed', icon:Hash, l:'Feed'}, {id:'friends', icon:Users, l:'P콏치tel칠'}, {id:'settings', icon:Settings, l:'Nastaven칤'}].map(i => (
                                <button key={i.id} onClick={() => {setActiveTab(i.id); setActiveChat(null);}} className={`w-full flex items-center gap-4 p-3 rounded-xl transition-all ${activeTab===i.id?'bg-nexus-primary text-white':'hover:bg-nexus-primary/10 text-readable'}`}>
                                    <i.icon size={24}/> <span className="font-medium hidden md:block">{i.l}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-nexus-primary/10 flex items-center gap-3">
                            <img src={user.avatar} className="w-10 h-10 rounded-full border border-nexus-primary"/>
                            <div className="hidden md:block overflow-hidden flex-1">
                                <div className="font-bold text-sm truncate text-readable">{user.username}</div>
                                <div className="text-[10px] text-nexus-muted">{user.friendCode}</div>
                            </div>
                            <button onClick={onLogout}><LogOut className="text-nexus-danger hover:scale-110"/></button>
                        </div>
                    </aside>

                    {/* Main */}
                    <main className="flex-1 flex flex-col bg-nexus-bg relative overflow-hidden">
                        <header className="h-16 glass flex items-center justify-between px-8 z-10 shrink-0">
                            <h2 className="text-xl font-bold capitalize text-nexus-primary">{activeTab === 'friends' && activeChat ? activeChat.name : activeTab}</h2>
                            <div className="flex gap-4 relative">
                                <button className="text-nexus-muted hover:text-nexus-primary"><Search size={20}/></button>
                                <button onClick={() => setShowRequests(!showRequests)} className="text-nexus-muted hover:text-nexus-primary relative">
                                    <Bell size={20}/>
                                </button>
                                {showRequests && (
                                    <div className="absolute right-0 top-10 w-64 bg-nexus-card border border-nexus-primary/20 rounded-xl shadow-xl p-4 z-50 animate-fade-in text-readable">
                                        <h3 className="text-xs font-bold uppercase text-nexus-muted mb-2">콯치dosti o p콏치telstv칤</h3>
                                        <div className="text-center text-sm text-nexus-muted">Zat칤m 쮂멳n칠 쮂멳osti.</div>
                                    </div>
                                )}
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {/* FEED */}
                            {activeTab === 'feed' && (
                                <div className="max-w-2xl mx-auto space-y-8 pb-20">
                                    <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar items-center">
                                        <div onClick={() => setShowAddContent(true)} className="flex flex-col items-center gap-2 cursor-pointer group shrink-0">
                                            <div className="w-16 h-16 rounded-full border-2 border-dashed border-nexus-muted flex items-center justify-center hover:border-nexus-primary hover:text-nexus-primary bg-nexus-card">
                                                <Plus size={24}/>
                                            </div>
                                            <span className="text-xs font-bold text-nexus-muted">P콏idat</span>
                                        </div>
                                        {stories.map(s => (
                                            <div key={s.id} onClick={() => setViewingStory(s)} className="flex flex-col items-center gap-2 cursor-pointer shrink-0">
                                                <div className="w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr from-nexus-primary to-blue-500">
                                                    <div className="w-full h-full rounded-full bg-nexus-bg p-[2px]"><img src={s.avatar} className="w-full h-full rounded-full object-cover"/></div>
                                                </div>
                                                <span className="text-xs font-bold text-readable">{s.user}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="space-y-6">
                                        {posts.map(post => (
                                            <div key={post.id} className="bg-nexus-card border border-nexus-primary/10 rounded-2xl overflow-hidden shadow-lg animate-fade-in">
                                                <div className="p-4 flex items-center gap-3">
                                                    <img src={post.avatar} className="w-10 h-10 rounded-full"/>
                                                    <div><div className="font-bold text-sm text-readable">{post.user}</div><div className="text-xs text-nexus-muted">Pr치v캩 te캞</div></div>
                                                </div>
                                                <div className="px-4 pb-2 text-readable"><h3 className="font-bold text-lg">{post.title}</h3><p className="text-sm opacity-80">{post.desc}</p></div>
                                                {post.image && <img src={post.image} className="w-full h-64 object-cover"/>}
                                                <div className="p-4 flex gap-4 border-t border-nexus-primary/10">
                                                    <Heart size={20} className="text-nexus-muted hover:text-nexus-primary cursor-pointer"/> <span className="text-sm text-nexus-muted">{post.likes}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* FRIENDS */}
                            {activeTab === 'friends' && (
                                !activeChat ? (
                                    <div>
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-nexus-muted uppercase">Seznam P콏치tel</h3>
                                            <button onClick={() => setShowAddFriend(true)} className="text-nexus-primary text-sm font-bold flex items-center gap-1 hover:underline"><UserPlus size={16}/> P콏idat</button>
                                        </div>
                                        {showAddFriend && (
                                            <div className="mb-6 bg-nexus-dark p-4 rounded-xl flex gap-2 animate-fade-in">
                                                <input value={friendCode} onChange={e => setFriendCode(e.target.value)} placeholder="Zadejte Friend Code (#XXXX)" className="flex-1 bg-transparent border-b border-nexus-primary/50 outline-none text-readable"/>
                                                <button onClick={handleAddFriend} className="bg-nexus-primary text-white px-4 py-1 rounded-lg font-bold text-sm">Odeslat</button>
                                            </div>
                                        )}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {friends.map(f => (
                                                <div key={f.id} className="bg-nexus-card border border-nexus-primary/10 p-4 rounded-2xl flex items-center gap-3 relative">
                                                    <img src={f.avatar} className="w-12 h-12 rounded-full bg-nexus-dark"/>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-bold truncate text-readable">{f.name}</div>
                                                        <div className="text-xs text-nexus-muted">{f.status}</div>
                                                    </div>
                                                    <button onClick={() => setActiveChat(f)} className="bg-nexus-primary/10 text-nexus-primary px-3 py-1 rounded text-xs font-bold hover:bg-nexus-primary hover:text-white">Chat</button>
                                                    <button className="p-2 text-nexus-muted hover:text-readable"><Phone size={16}/></button>
                                                </div>
                                            ))}
                                        </div>
                                        {friends.length === 0 && <div className="text-center text-nexus-muted mt-10">Zat칤m nem치te 쮂멳n칠 p콏치tele.</div>}
                                    </div>
                                ) : (
                                    <div className="flex flex-col h-full bg-nexus-card rounded-2xl border border-nexus-primary/10 overflow-hidden animate-fade-in">
                                        <div className="h-14 border-b border-nexus-primary/10 flex items-center justify-between px-4 bg-nexus-dark">
                                            <div className="flex items-center gap-3">
                                                <button onClick={() => setActiveChat(null)} className="text-readable"><ArrowLeft/></button>
                                                <img src={activeChat.avatar} className="w-8 h-8 rounded-full"/>
                                                <span className="font-bold text-readable">{activeChat.name}</span>
                                            </div>
                                            <div className="flex gap-2 text-nexus-primary"><Phone/><Video/></div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                            {chatMsgs.map(m => (
                                                <div key={m.id} className="flex justify-end">
                                                    {m.image ? <img src={m.image} className="max-w-[70%] rounded-xl border border-nexus-primary"/> : <div className="bg-nexus-primary text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[70%] text-sm">{m.text}</div>}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="p-3 bg-nexus-dark border-t border-nexus-primary/10 flex items-center gap-2">
                                            <input type="file" ref={chatFileRef} hidden onChange={handleChatUpload} accept="image/*"/>
                                            <Plus size={20} className="text-nexus-muted cursor-pointer hover:text-nexus-primary" onClick={() => chatFileRef.current.click()}/>
                                            <input onKeyDown={(e) => {if(e.key==='Enter'){setChatMsgs([...chatMsgs, {id: Date.now(), text: e.target.value}]); e.target.value='';}}} placeholder="Zpr치va..." className="flex-1 bg-nexus-bg rounded-full px-4 py-2 text-readable outline-none border border-nexus-primary/20"/>
                                            <Send size={20} className="text-nexus-primary cursor-pointer"/>
                                        </div>
                                    </div>
                                )
                            )}

                            {/* SETTINGS */}
                            {activeTab === 'settings' && <SettingsPanel user={user} onUpdateUser={setUser} />}
                        </div>

                        {/* Modals */}
                        <AddContentModal isOpen={showAddContent} onClose={() => setShowAddContent(false)} onPost={handleNewPost} user={user} />
                        <StoryViewer story={viewingStory} onClose={() => setViewingStory(null)} />
                    </main>
                </div>
            );
        };

        // --- AUTH ---
        const Auth = () => {
            const [mode, setMode] = useState('login');
            const [data, setData] = useState({email:'', pass:''});
            const [showToS, setShowToS] = useState(false);
            const [loading, setLoading] = useState(false);
            const [user, setUser] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    const u = await apiFetch('/api/auth/'+mode, {
                        method: 'POST', body: JSON.stringify({ email: data.email, password: data.pass })
                    });
                    if(u && u.user) setUser(u.user);
                    else alert("Chyba p콏ihl치코en칤");
                } catch(err) { alert(err.message); }
                setLoading(false);
            };

            if(user) return <Dashboard user={user} onLogout={() => setUser(null)}/>;

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-black relative overflow-hidden">
                    <div className="glass p-8 rounded-3xl w-full max-w-md relative z-10 animate-fade-in border border-white/10">
                        <div className="flex justify-center mb-6"><Zap size={40} className="text-nexus-primary"/></div>
                        <h1 className="text-4xl font-black text-center text-white mb-8">NexTalk</h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="bg-nexus-dark border border-white/10 rounded-xl p-3 flex items-center gap-3">
                                <Mail size={20} className="text-nexus-muted"/>
                                <input type="email" placeholder="Email" value={data.email} onChange={e => setData({...data, email: e.target.value})} className="bg-transparent flex-1 text-white outline-none" required/>
                            </div>
                            <div className="bg-nexus-dark border border-white/10 rounded-xl p-3 flex items-center gap-3">
                                <Lock size={20} className="text-nexus-muted"/>
                                <input type="password" placeholder="Heslo" value={data.pass} onChange={e => setData({...data, pass: e.target.value})} className="bg-transparent flex-1 text-white outline-none" required/>
                            </div>
                            <button disabled={loading} className="w-full bg-nexus-primary py-4 rounded-xl text-white font-bold hover:opacity-90 transition-all flex justify-center items-center gap-2">
                                {loading ? <Loader2 className="animate-spin"/> : (mode === 'login' ? 'P콏ihl치sit se' : 'Vytvo콏it 칰캜et')}
                            </button>
                        </form>
                        <div className="mt-6 text-center text-xs text-nexus-muted">
                            <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-nexus-primary hover:underline font-bold">
                                {mode === 'login' ? 'Registrovat se' : 'P콏ihl치sit se'}
                            </button>
                        </div>
                        <div className="mt-4 text-center">
                            <button onClick={() => setShowToS(true)} className="text-[10px] text-nexus-muted hover:text-white uppercase tracking-widest">Pravidla (ToS)</button>
                        </div>
                    </div>
                    <ToSModal isOpen={showToS} onClose={() => setShowToS(false)} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<Auth />);
    </script>
</body>
</html>
