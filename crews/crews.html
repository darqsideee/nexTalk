<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexTalk - Crews</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb, rgba(255, 255, 255, 0.1));
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover, rgba(255, 255, 255, 0.2));
        }

        /* Theme Variables Defaults */
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --accent: #7A4DFF;
            --border: rgba(255, 255, 255, 0.05);
            --msg-me: #7A4DFF;
            --msg-them: #27272a;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
    </style>
</head>

<body class="h-screen overflow-hidden selection:bg-[#7A4DFF] selection:text-white" id="app-body">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            MessageSquare, Users, Settings, Heart, Send, Plus,
            Image as ImageIcon, Search, Bell, LogOut,
            MoreVertical, Phone, Video, X, Zap, Eye, EyeOff,
            Hash, Mail, AlertTriangle, CheckCircle, RefreshCw,
            Camera, ChevronLeft, ChevronRight, Shield,
            User, Lock, Trash2, Ban, Globe, Mic, Volume2, UserPlus,
            Paperclip, MessageCircle, Activity, Skull, Ghost, MicOff, VolumeX
        } from 'lucide-react';

        import { initializeApp } from 'firebase/app';
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            onAuthStateChanged, signOut, sendEmailVerification, sendPasswordResetEmail, updatePassword, updateEmail
        } from 'firebase/auth';
        import {
            getFirestore, collection, doc, setDoc, addDoc, onSnapshot,
            query, orderBy, serverTimestamp, updateDoc, deleteDoc, getDoc, where, arrayUnion, arrayRemove
        } from 'firebase/firestore';

        window.process = { env: { NODE_ENV: 'production' } };

        const firebaseConfig = {
            apiKey: "AIzaSyClqVa0abAGdbWre1SgNQ_LPE3OhFgwqC4",
            authDomain: "nextalk-4cb86.firebaseapp.com",
            projectId: "nextalk-4cb86",
            storageBucket: "nextalk-4cb86.firebasestorage.app",
            messagingSenderId: "894596255124",
            appId: "1:894596255124:web:6fdd8b80b8e96fc9aad381",
            measurementId: "G-M8EDS7KCE2"
        };

        const _appId = 'nextalk-production-v11';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const generateFriendCode = () => {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const prefix = Array(3).fill(0).map(() => letters[Math.floor(Math.random() * letters.length)]).join('');
            const suffix = Math.floor(100000 + Math.random() * 900000).toString();
            return `${prefix}-${suffix}`;
        };

        const generateCrewCode = () => {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const prefix = Math.floor(100000 + Math.random() * 900000).toString();
            const suffix = Array(6).fill(0).map(() => letters[Math.floor(Math.random() * letters.length)]).join('');
            return `${prefix}-${suffix}`;
        };

        const getAvatar = (uid) => `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}&backgroundColor=b6e3f4`;

        const handleRealFileUpload = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        const ThemeInjector = ({ theme, customColors }) => {
            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'light') {
                    root.style.setProperty('--bg-primary', '#f4f4f5');
                    root.style.setProperty('--bg-secondary', '#ffffff');
                    root.style.setProperty('--bg-tertiary', '#e4e4e7');
                    root.style.setProperty('--text-primary', '#18181b');
                    root.style.setProperty('--text-secondary', '#71717a');
                    root.style.setProperty('--border', 'rgba(0,0,0,0.1)');
                    root.style.setProperty('--scrollbar-thumb', 'rgba(0,0,0,0.2)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#e4e4e7');
                } else if (theme === 'custom' && customColors) {
                    root.style.setProperty('--bg-primary', customColors.bgPrimary);
                    root.style.setProperty('--bg-secondary', customColors.bgSecondary);
                    root.style.setProperty('--bg-tertiary', customColors.bgSecondary + '80');
                    root.style.setProperty('--text-primary', customColors.text);
                    root.style.setProperty('--text-secondary', customColors.text + '99');
                    root.style.setProperty('--accent', customColors.accent);
                    root.style.setProperty('--border', customColors.text + '20');
                    root.style.setProperty('--msg-me', customColors.accent);
                    root.style.setProperty('--msg-them', customColors.bgSecondary + '90');
                } else {
                    root.style.setProperty('--bg-primary', '#0f0f13');
                    root.style.setProperty('--bg-secondary', '#18181b');
                    root.style.setProperty('--bg-tertiary', '#27272a');
                    root.style.setProperty('--text-primary', '#ffffff');
                    root.style.setProperty('--text-secondary', 'rgba(255,255,255,0.6)');
                    root.style.setProperty('--border', 'rgba(255,255,255,0.05)');
                    root.style.setProperty('--msg-me', '#7A4DFF');
                    root.style.setProperty('--msg-them', '#27272a');
                }
            }, [theme, customColors]);
            return null;
        };

        const GlassCard = ({ children, className = "", onClick, onContextMenu }) => (
            <div onClick={onClick} onContextMenu={onContextMenu} className={`backdrop-blur-xl bg-[var(--bg-secondary)] border border-[var(--border)] shadow-xl ${className}`}>
                {children}
            </div>
        );

        const Modal = ({ onClose, title, children }) => (
            <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                <GlassCard className="w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col rounded-2xl bg-[var(--bg-secondary)]">
                    <div className="p-5 border-b border-[var(--border)] flex justify-between items-center">
                        <h2 className="text-xl font-bold text-[var(--text-primary)]">{title}</h2>
                        <button onClick={onClose} className="p-1 hover:bg-[var(--bg-tertiary)] rounded-full text-[var(--text-primary)]"><X size={20} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto custom-scrollbar text-[var(--text-primary)]">
                        {children}
                    </div>
                </GlassCard>
            </div>
        );

        const Button = ({ children, onClick, className = "", variant = "primary" }) => {
            const styles = {
                primary: "bg-[var(--accent)] text-white hover:brightness-110",
                secondary: "bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-opacity-80",
                danger: "bg-red-500/20 text-red-500 hover:bg-red-500/30"
            };
            return (
                <button onClick={onClick} className={`px-4 py-2 rounded-xl font-bold transition-all active:scale-95 ${styles[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ type = "text", placeholder, value, onChange, icon: Icon, className = "" }) => (
            <div className="relative w-full">
                {Icon && <Icon className="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] w-5 h-5" />}
                <input
                    type={type}
                    placeholder={placeholder}
                    value={value}
                    onChange={onChange}
                    className={`w-full bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl py-3 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent)] transition-all ${Icon ? 'pl-12' : 'pl-4'} ${className}`}
                />
            </div>
        );

        // CREWS (SERVERS)
        const Crews = ({ user, allUsers }) => {
            const [crews, setCrews] = useState([]);
            const [selectedCrew, setSelectedCrew] = useState(null);
            const [activeChannel, setActiveChannel] = useState('general');
            const [showCreate, setShowCreate] = useState(false);
            const [showJoin, setShowJoin] = useState(false);
            const [newCrewName, setNewCrewName] = useState("");
            const [joinCode, setJoinCode] = useState("");
            const [contextMenu, setContextMenu] = useState(null);
            const [messages, setMessages] = useState([]);
            const [msgText, setMsgText] = useState("");
            const [manageModal, setManageModal] = useState(null);
            const [newChannelName, setNewChannelName] = useState("");
            const [newChannelType, setNewChannelType] = useState("text");
            const [attachment, setAttachment] = useState(null);
            const [voiceUsers, setVoiceUsers] = useState([]);
            const [isInVoice, setIsInVoice] = useState(false);
            const [isMuted, setIsMuted] = useState(false);

            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, 'artifacts', _appId, 'public', 'data', 'crews')), snap => {
                    setCrews(snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(c => !c.deleted));
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!selectedCrew) return;
                const unsub = onSnapshot(query(collection(db, 'artifacts', _appId, 'public', 'data', 'crews', selectedCrew.id, 'channels', activeChannel, 'messages'), orderBy('createdAt', 'asc')), snap => {
                    setMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(m => !m.deleted));
                });
                return () => unsub();
            }, [selectedCrew, activeChannel]);

            // Voice Channel Listener
            useEffect(() => {
                if (!selectedCrew || !activeChannel) return;
                const isVoice = selectedCrew.channels.find(c => c.name === activeChannel && c.type === 'voice');
                if (isVoice || activeChannel.includes('voice')) { // Fallback check
                    // Mocking voice users for now as we don't have a real backend for presence in subcollections easily without more logic
                    // In a real app, we'd write to a 'presence' collection.
                    // For this demo, we'll just use local state for the UI.
                }
            }, [selectedCrew, activeChannel]);

            const handleCreate = async () => {
                if (!newCrewName) return;
                const code = generateCrewCode();
                await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'crews'), {
                    name: newCrewName, owner: user.uid, icon: `https://ui-avatars.com/api/?name=${newCrewName}&background=random`,
                    members: [user.uid], channels: [{ name: 'general', type: 'text' }, { name: 'voice', type: 'voice' }], suspended: false,
                    joinCode: code
                });
                setShowCreate(false); setNewCrewName("");
            };

            const handleJoin = async () => {
                if (!joinCode) return;
                const q = query(collection(db, 'artifacts', _appId, 'public', 'data', 'crews'), where("joinCode", "==", joinCode));
                const snap = await getDoc(q); // getDoc won't work with query, need getDocs but we only have onSnapshot imported or need to import getDocs.
                // Actually we have crews in state, let's filter locally for simplicity or use the correct query method if we imported getDocs (which we didn't).
                // Wait, we can just iterate crews since we have them all loaded (not ideal for scale but fine for demo).
                const targetCrew = crews.find(c => c.joinCode === joinCode);

                if (targetCrew) {
                    if (targetCrew.members.includes(user.uid)) {
                        alert("Už jsi členem!");
                    } else {
                        await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'crews', targetCrew.id), {
                            members: arrayUnion(user.uid)
                        });
                        alert("Připojeno!");
                        setShowJoin(false); setJoinCode("");
                    }
                } else {
                    alert("Crew nenalezena.");
                }
            };

            const handleAddChannel = async () => {
                if (!newChannelName || !selectedCrew) return;
                const newChannels = [...selectedCrew.channels, { name: newChannelName, type: newChannelType }];
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'crews', selectedCrew.id), {
                    channels: newChannels
                });
                setManageModal(null); setNewChannelName("");
            };

            const handleAttachment = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const url = await handleRealFileUpload(file);
                setAttachment(url);
            };

            const sendMessage = async () => {
                if (!msgText.trim() && !attachment) return;
                await addDoc(collection(db, 'artifacts', _appId, 'public', 'data', 'crews', selectedCrew.id, 'channels', activeChannel, 'messages'), {
                    text: msgText, imageUrl: attachment, authorId: user.uid, createdAt: serverTimestamp()
                });
                setMsgText("");
                setAttachment(null);
            };

            const handleContextMenu = (e, type, data) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type, data }); };

            const handleMessageAction = async (action) => {
                if (action === 'delete') {
                    await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'crews', selectedCrew.id, 'channels', activeChannel, 'messages', contextMenu.data.id), { deleted: true });
                } else if (action === 'copy') {
                    navigator.clipboard.writeText(contextMenu.data.text);
                }
                setContextMenu(null);
            };

            const handleChannelAction = async (action) => {
                if (action === 'delete') {
                    const newCh = selectedCrew.channels.filter(c => c.name !== contextMenu.data.name);
                    await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'crews', selectedCrew.id), { channels: newCh });
                    if (activeChannel === contextMenu.data.name) setActiveChannel('general');
                }
                setContextMenu(null);
            };

            const handleLeave = async () => {
                if (contextMenu.data.suspended) return alert("Nelze opustit pozastavený server.");
                if (contextMenu.data.owner === user.uid) return alert("Jako zakladatel nemůžeš odejít. Musíš server smazat.");
                const newMembers = contextMenu.data.members.filter(m => m !== user.uid);
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'crews', contextMenu.data.id), { members: newMembers });
                setSelectedCrew(null); setContextMenu(null);
            };

            const handleDeleteServer = async () => {
                if (contextMenu.data.suspended) return alert("Nelze smazat pozastavený server.");
                if (contextMenu.data.owner !== user.uid) return alert("Nejsi majitel!");
                await updateDoc(doc(db, 'artifacts', _appId, 'public', 'data', 'crews', contextMenu.data.id), { deleted: true });
                setContextMenu(null); setSelectedCrew(null);
            };

            const joinVoice = () => {
                setIsInVoice(true);
                setVoiceUsers(prev => [...prev, user.uid]);
            };

            const leaveVoice = () => {
                setIsInVoice(false);
                setVoiceUsers(prev => prev.filter(id => id !== user.uid));
            };

            // Helper to get channel object
            const getChannel = (name) => {
                if (typeof name === 'string') {
                    // Legacy support if channels were strings
                    return selectedCrew.channels.find(c => c.name === name) || { name, type: name.includes('voice') ? 'voice' : 'text' };
                }
                return name;
            }

            const currentChannelObj = selectedCrew?.channels.find(c => (c.name || c) === activeChannel) || { name: activeChannel, type: 'text' };
            const isVoiceChannel = currentChannelObj.type === 'voice' || (typeof currentChannelObj === 'string' && currentChannelObj.includes('voice'));

            return (
                <div className="flex h-full bg-[var(--bg-primary)] justify-center">
                    <div className="w-full max-w-4xl flex flex-col h-full">
                        <div className="p-6 pb-2 text-center">
                            <h2 className="text-2xl font-bold mb-4 text-[var(--text-primary)]">Crews</h2>
                            <div className="flex gap-2 justify-center mb-6">
                                <Button onClick={() => setShowCreate(true)} className="w-40">Vytvořit Crew</Button>
                                <Button onClick={() => setShowJoin(true)} variant="secondary" className="w-40">Připojit se</Button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto px-6 space-y-4 pb-20 custom-scrollbar">
                            {crews.filter(c => c.members.includes(user.uid)).map(crew => (
                                <div key={crew.id} className="bg-[var(--bg-secondary)] border border-[var(--border)] rounded-2xl overflow-hidden transition-all">
                                    <div className={`p-4 flex items-center gap-4 cursor-pointer hover:bg-[var(--bg-tertiary)] ${selectedCrew?.id === crew.id ? 'bg-[var(--bg-tertiary)]' : ''}`} onClick={() => setSelectedCrew(selectedCrew?.id === crew.id ? null : crew)} onContextMenu={(e) => handleContextMenu(e, 'crew', crew)}>
                                        <img src={crew.icon} className="w-14 h-14 rounded-xl object-cover" />
                                        <div className="flex-1">
                                            <div className="font-bold text-lg text-[var(--text-primary)]">{crew.name}</div>
                                            <div className="text-sm text-[var(--text-secondary)]">{crew.members.length} členů • ID: {crew.joinCode || 'N/A'}</div>
                                        </div>
                                        {crew.suspended && <Shield className="text-red-500" />}
                                        <ChevronRight className={`transition-transform duration-300 text-[var(--text-secondary)] ${selectedCrew?.id === crew.id ? 'rotate-90' : ''}`} />
                                    </div>

                                    {selectedCrew?.id === crew.id && (
                                        <div className="border-t border-[var(--border)] bg-[var(--bg-primary)] animate-in slide-in-from-top-2 duration-200">
                                            {crew.suspended ? (
                                                <div className="p-8 text-center text-red-500 bg-red-500/10 m-4 rounded-xl border border-red-500/20">
                                                    <Shield size={48} className="mx-auto mb-4" />
                                                    <h3 className="text-xl font-bold">Server Pozastaven</h3>
                                                    <p className="text-sm opacity-80">Tento server byl pozastaven administrátorem. Nelze psát zprávy ani se připojovat.</p>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="p-2 grid grid-cols-3 gap-2">
                                                        {crew.channels.map(ch => {
                                                            const chName = ch.name || ch;
                                                            const chType = ch.type || (chName.includes('voice') ? 'voice' : 'text');
                                                            return (
                                                                <div key={chName} onClick={() => setActiveChannel(chName)} onContextMenu={(e) => handleContextMenu(e, 'channel', ch)} className={`p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer transition ${activeChannel === chName ? 'bg-[var(--accent)] text-white' : 'bg-[var(--bg-secondary)] text-[var(--text-secondary)] hover:text-[var(--text-primary)]'}`}>
                                                                    {chType === 'voice' ? <Volume2 size={16} /> : <Hash size={16} />} {chName}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>

                                                    <div className="h-96 flex flex-col bg-[var(--bg-secondary)] m-2 rounded-xl border border-[var(--border)]">
                                                        <div className="p-3 border-b border-[var(--border)] font-bold text-[var(--text-primary)] flex items-center gap-2">
                                                            {isVoiceChannel ? <Volume2 size={16} /> : <Hash size={16} />} {activeChannel}
                                                        </div>

                                                        {isVoiceChannel ? (
                                                            <div className="flex-1 flex flex-col items-center justify-center p-6 space-y-6">
                                                                <div className="flex flex-wrap justify-center gap-4">
                                                                    {voiceUsers.map(uid => (
                                                                        <div key={uid} className="flex flex-col items-center gap-2">
                                                                            <div className="relative">
                                                                                <img src={allUsers[uid]?.avatarUrl} className="w-16 h-16 rounded-full border-2 border-green-500" />
                                                                                <div className="absolute bottom-0 right-0 bg-green-500 p-1 rounded-full"><Mic size={12} className="text-white" /></div>
                                                                            </div>
                                                                            <span className="text-sm font-bold">{allUsers[uid]?.displayName}</span>
                                                                        </div>
                                                                    ))}
                                                                    {voiceUsers.length === 0 && <div className="text-[var(--text-secondary)]">Kanál je prázdný</div>}
                                                                </div>

                                                                <div className="flex gap-4">
                                                                    {!isInVoice ? (
                                                                        <Button onClick={joinVoice} className="bg-green-600 hover:bg-green-500 px-8">Připojit se</Button>
                                                                    ) : (
                                                                        <>
                                                                            <button onClick={() => setIsMuted(!isMuted)} className={`p-3 rounded-full ${isMuted ? 'bg-red-500/20 text-red-500' : 'bg-[var(--bg-tertiary)]'}`}>{isMuted ? <MicOff /> : <Mic />}</button>
                                                                            <Button onClick={leaveVoice} className="bg-red-600 hover:bg-red-500 px-8">Odpojit se</Button>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <>
                                                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                                                    {messages.map(msg => (
                                                                        <div key={msg.id} onContextMenu={(e) => handleContextMenu(e, 'message', msg)} className={`flex gap-3 ${msg.authorId === user.uid ? 'flex-row-reverse' : ''}`}>
                                                                            <img src={allUsers[msg.authorId]?.avatarUrl} className="w-8 h-8 rounded-full mt-1" />
                                                                            <div className={`px-4 py-2 rounded-2xl max-w-[80%] text-sm ${msg.authorId === user.uid ? 'bg-[var(--msg-me)] text-white' : 'bg-[var(--msg-them)] text-[var(--text-primary)]'}`}>
                                                                                {msg.imageUrl && <img src={msg.imageUrl} className="max-w-full rounded-lg mb-2 border border-white/10" />}
                                                                                {msg.text}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                                {attachment && (
                                                                    <div className="mx-4 mb-2 p-2 bg-[var(--bg-tertiary)] rounded-lg flex items-center gap-2 border border-[var(--accent)]">
                                                                        <div className="w-10 h-10 bg-black/50 rounded overflow-hidden"><img src={attachment} className="w-full h-full object-cover" /></div>
                                                                        <span className="text-xs text-[var(--text-secondary)] flex-1">Obrázek připraven</span>
                                                                        <button onClick={() => setAttachment(null)}><X size={16} className="text-red-400" /></button>
                                                                    </div>
                                                                )}
                                                                <div className="p-3 bg-[var(--bg-tertiary)] m-2 rounded-xl flex gap-2 items-center">
                                                                    <div className="relative group">
                                                                        <Paperclip size={20} className="text-[var(--text-secondary)] hover:text-[var(--text-primary)] cursor-pointer" />
                                                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleAttachment} />
                                                                    </div>
                                                                    <input value={msgText} onChange={e => setMsgText(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} placeholder={`Zpráva...`} className="bg-transparent flex-1 outline-none text-[var(--text-primary)]" />
                                                                    <button onClick={sendMessage}><Send className="text-[var(--accent)]" /></button>
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {contextMenu && (
                        <div className="fixed z-50 bg-[var(--bg-secondary)] border border-[var(--border)] shadow-xl rounded-lg w-48 py-1 overflow-hidden animate-in fade-in zoom-in-95 duration-100" style={{ top: contextMenu.y, left: contextMenu.x }}>
                            {contextMenu.type === 'crew' && (
                                <>
                                    <div className="px-4 py-2 border-b border-[var(--border)] font-bold text-sm text-[var(--text-primary)]">{contextMenu.data.name}</div>
                                    <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-[var(--text-primary)]" onClick={() => { setManageModal('players'); setContextMenu(null); }}>Hráči</button>
                                    {contextMenu.data.owner === user.uid && <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-[var(--text-primary)]" onClick={() => { setManageModal('manage'); setContextMenu(null); }}>Spravovat</button>}
                                    <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-red-400" onClick={handleLeave}>Opustit</button>
                                    {contextMenu.data.owner === user.uid && <button onClick={handleDeleteServer} className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-red-500 font-bold">Odstranit</button>}
                                </>
                            )}
                            {contextMenu.type === 'channel' && (
                                <>
                                    <div className="px-4 py-2 border-b border-[var(--border)] font-bold text-sm text-[var(--text-primary)]">#{contextMenu.data.name || contextMenu.data}</div>
                                    {selectedCrew.owner === user.uid && (
                                        <>
                                            <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-[var(--text-primary)]">Přejmenovat</button>
                                            <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-red-400" onClick={() => handleChannelAction('delete')}>Odstranit</button>
                                        </>
                                    )}
                                </>
                            )}
                            {contextMenu.type === 'message' && (
                                <>
                                    <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-[var(--text-primary)]" onClick={() => handleMessageAction('copy')}>Kopírovat</button>
                                    <button className="w-full text-left px-4 py-2 text-sm hover:bg-[var(--bg-tertiary)] text-red-400" onClick={() => handleMessageAction('delete')}>Vymazat</button>
                                </>
                            )}
                            <div className="fixed inset-0 -z-10" onClick={() => setContextMenu(null)}></div>
                        </div>
                    )}

                    {showCreate && (
                        <Modal title="Vytvořit Crew" onClose={() => setShowCreate(false)}>
                            <div className="space-y-4">
                                <Input placeholder="Název Crew" value={newCrewName} onChange={e => setNewCrewName(e.target.value)} />
                                <Button onClick={handleCreate} className="w-full">Vytvořit svět</Button>
                            </div>
                        </Modal>
                    )}
                    {showJoin && (
                        <Modal title="Připojit se k Crew" onClose={() => setShowJoin(false)}>
                            <div className="space-y-4">
                                <Input placeholder="Kód Crew (např. 123456-ABCDEF)" value={joinCode} onChange={e => setJoinCode(e.target.value)} />
                                <Button onClick={handleJoin} className="w-full">Připojit se</Button>
                            </div>
                        </Modal>
                    )}
                    {manageModal === 'manage' && (
                        <Modal title={`Správa: ${selectedCrew?.name}`} onClose={() => setManageModal(null)}>
                            <div className="space-y-4">
                                <div className="text-sm opacity-50 uppercase">Vytvořit Kanál</div>
                                <div className="flex gap-2">
                                    <Input placeholder="Název kanálu" value={newChannelName} onChange={e => setNewChannelName(e.target.value)} />
                                    <select className="bg-[var(--bg-tertiary)] text-[var(--text-primary)] rounded-xl px-2 outline-none border border-[var(--border)]" value={newChannelType} onChange={e => setNewChannelType(e.target.value)}>
                                        <option value="text">Text</option>
                                        <option value="voice">Hlas</option>
                                    </select>
                                </div>
                                <Button onClick={handleAddChannel} className="w-full">Přidat</Button>
                            </div>
                        </Modal>
                    )}
                    {manageModal === 'players' && (
                        <Modal title="Seznam hráčů" onClose={() => setManageModal(null)}>
                            <div className="space-y-2">
                                {selectedCrew?.members?.map(mid => (
                                    <div key={mid} className="flex items-center gap-2 p-2 rounded hover:bg-[var(--bg-tertiary)] text-[var(--text-primary)]">
                                        <img src={allUsers[mid]?.avatarUrl} className="w-8 h-8 rounded-full" />
                                        <span>{allUsers[mid]?.displayName}</span>
                                    </div>
                                ))}
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [allUsers, setAllUsers] = useState({});
            const [notifications, setNotifications] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                let unsubSnapshot = null;
                const unsubAuth = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        if (unsubSnapshot) unsubSnapshot();
                        const userDocRef = doc(db, 'artifacts', _appId, 'public', 'data', 'users', u.uid);
                        unsubSnapshot = onSnapshot(userDocRef, async (docSnap) => {
                            if (docSnap.exists()) {
                                setUser({ ...docSnap.data(), isVerified: u.emailVerified });
                            } else {
                                await setDoc(userDocRef, {
                                    uid: u.uid, email: u.email, displayName: u.displayName || u.email.split('@')[0],
                                    friendCode: generateFriendCode(), avatarUrl: getAvatar(u.uid),
                                    status: 'online', friends: [], blocked: [], bio: "Welcome to NexTalk",
                                    theme: 'dark', joinedAt: serverTimestamp()
                                });
                            }
                            setLoading(false);
                        });
                    } else {
                        if (unsubSnapshot) unsubSnapshot();
                        setUser(null);
                        setLoading(false);
                        window.location.href = '../auth/login.html';
                    }
                });
                return () => { unsubAuth(); if (unsubSnapshot) unsubSnapshot(); };
            }, []);

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', _appId, 'public', 'data', 'users'), s => { const m = {}; s.forEach(d => m[d.id] = { uid: d.id, ...d.data() }); setAllUsers(m); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', _appId, 'public', 'data', 'friend_requests'), where("to", "==", user.uid), where("status", "==", "pending"));
                return onSnapshot(q, s => setNotifications(s.docs));
            }, [user]);

            if (loading) return <div className="h-screen w-screen bg-[#0f0f13]"></div>;
            if (!user) return <AuthScreen onLogin={() => { }} />;

            return (
                <div className="flex h-screen overflow-hidden">
                    <ThemeInjector theme={user.theme} customColors={user.customColors} />
                    <nav className="w-20 bg-[var(--bg-secondary)] border-r border-[var(--border)] flex flex-col items-center py-6 gap-6 z-20">
                        <div className="w-12 h-12 bg-gradient-to-tr from-[var(--accent)] to-purple-400 rounded-xl flex items-center justify-center shadow-lg"><Zap className="text-white" /></div>

                        <a href="../feed/feed.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Hash /></a>

                        <div className="relative">
                            <a href="../friends/friends.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]">
                                <Users />
                            </a>
                            {notifications.length > 0 && <div className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-[var(--bg-primary)] animate-pulse" />}
                        </div>

                        <a href="../crews/crews.html" className="p-3 rounded-xl transition bg-[var(--accent)] text-white"><Globe /></a>
                        {user.isAdmin && <a href="../admin/admin.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:text-red-500"><Shield /></a>}

                        <div className="mt-auto flex flex-col gap-4">
                            <a href="../settings/settings.html" className="p-3 rounded-xl transition text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)]"><Settings /></a>
                            <button onClick={() => signOut(auth)}><LogOut className="text-[var(--text-secondary)] hover:text-red-400" /></button>
                        </div>
                    </nav>
                    <main className="flex-1 bg-[var(--bg-primary)] overflow-hidden relative">
                        <Crews user={user} allUsers={allUsers} />
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
